[{"node": {"avatar_large": "https://cdn.v2ex.com/navatar/6e27/13a6/557_large.png?m=1608969785", "name": "life", "avatar_normal": "https://cdn.v2ex.com/navatar/6e27/13a6/557_normal.png?m=1608969785", "title": "生活", "url": "https://www.v2ex.com/go/life", "topics": 6253, "footer": "", "header": "生活中的技术讨论", "title_alternative": "Life", "avatar_mini": "https://cdn.v2ex.com/navatar/6e27/13a6/557_mini.png?m=1608969785", "stars": 1503, "aliases": [], "root": false, "id": 557, "parent_node_name": ""}, "member": {"id": 662642, "username": "hello202311", "url": "https://www.v2ex.com/u/hello202311", "website": "", "twitter": null, "psn": null, "github": null, "btc": null, "location": "", "tagline": "", "bio": "tha816674@谷歌.com", "avatar_mini": "https://cdn.v2ex.com/gravatar/c6fda93eaebac1d96038370f3c7c8ba8?s=24&d=retro", "avatar_normal": "https://cdn.v2ex.com/gravatar/c6fda93eaebac1d96038370f3c7c8ba8?s=48&d=retro", "avatar_large": "https://cdn.v2ex.com/gravatar/c6fda93eaebac1d96038370f3c7c8ba8?s=73&d=retro", "created": 1700030652, "last_modified": 1700030652}, "last_reply_by": "hello202311", "last_touched": 1725131875, "title": "买菜是去超市好还是菜市场？", "url": "https://www.v2ex.com/t/1069215", "created": 1725082069, "deleted": 0, "content": "个人倾向于超市，菜市场会看人下价，会缺斤短两，遇到问题理赔困难", "content_rendered": "<p>个人倾向于超市，菜市场会看人下价，会缺斤短两，遇到问题理赔困难</p>\n", "last_modified": 1725090675, "replies": 65, "id": 1069215}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/6e27/13a6/557_large.png?m=1608969785", "name": "life", "avatar_normal": "https://cdn.v2ex.com/navatar/6e27/13a6/557_normal.png?m=1608969785", "title": "生活", "url": "https://www.v2ex.com/go/life", "topics": 6253, "footer": "", "header": "生活中的技术讨论", "title_alternative": "Life", "avatar_mini": "https://cdn.v2ex.com/navatar/6e27/13a6/557_mini.png?m=1608969785", "stars": 1503, "aliases": [], "root": false, "id": 557, "parent_node_name": ""}, "member": {"id": 471425, "username": "AndyJMR", "url": "https://www.v2ex.com/u/AndyJMR", "website": null, "twitter": null, "psn": null, "github": null, "btc": null, "location": null, "tagline": null, "bio": null, "avatar_mini": "https://cdn.v2ex.com/avatar/eea3/54cc/471425_mini.png?m=1724289101", "avatar_normal": "https://cdn.v2ex.com/avatar/eea3/54cc/471425_normal.png?m=1724289101", "avatar_large": "https://cdn.v2ex.com/avatar/eea3/54cc/471425_large.png?m=1724289101", "avatar_xlarge": "https://cdn.v2ex.com/avatar/eea3/54cc/471425_xlarge.png?m=1724289101", "avatar_xxlarge": "https://cdn.v2ex.com/avatar/eea3/54cc/471425_xlarge.png?m=1724289101", "avatar_xxxlarge": "https://cdn.v2ex.com/avatar/eea3/54cc/471425_xlarge.png?m=1724289101", "created": 1582343138, "last_modified": 1724289101}, "last_reply_by": "zbz", "last_touched": 1725073330, "title": "老婆刚拿驾照，就把车撞了", "url": "https://www.v2ex.com/t/1069228", "created": 1725088213, "deleted": 0, "content": "老婆刚拿了驾照本，早上带出去练车。\n\n刚开了两圈，没想到，就追尾了前面的厢式货车。\n\n货车没啥事，我们车子外伤严重，好在人都没事。\n\n货车司机见前面是红绿灯，没有靠边停车，就停在路口下货，老婆看不见前面的红绿灯。\n\n就一根道，中间是双黄线，她问可不可以从货车左边绕过去，打晃错把油门当刹车踩了。\n\n求心理阴影面积。", "content_rendered": "老婆刚拿了驾照本，早上带出去练车。<br /><br />刚开了两圈，没想到，就追尾了前面的厢式货车。<br /><br />货车没啥事，我们车子外伤严重，好在人都没事。<br /><br />货车司机见前面是红绿灯，没有靠边停车，就停在路口下货，老婆看不见前面的红绿灯。<br /><br />就一根道，中间是双黄线，她问可不可以从货车左边绕过去，打晃错把油门当刹车踩了。<br /><br />求心理阴影面积。", "last_modified": 1725088213, "replies": 55, "id": 1069228}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/c20a/d4d7/12_large.png?m=1650095340", "name": "qna", "avatar_normal": "https://cdn.v2ex.com/navatar/c20a/d4d7/12_normal.png?m=1650095340", "title": "问与答", "url": "https://www.v2ex.com/go/qna", "topics": 222466, "footer": "", "header": "一个更好的世界需要你持续地提出好问题。", "title_alternative": "Questions and Answers", "avatar_mini": "https://cdn.v2ex.com/navatar/c20a/d4d7/12_mini.png?m=1650095340", "stars": 4229, "aliases": [], "root": false, "id": 12, "parent_node_name": "v2ex"}, "member": {"id": 588225, "username": "yegar", "url": "https://www.v2ex.com/u/yegar", "website": null, "twitter": null, "psn": null, "github": null, "btc": null, "location": null, "tagline": null, "bio": null, "avatar_mini": "https://cdn.v2ex.com/avatar/c559/74de/588225_mini.png?m=1722676805", "avatar_normal": "https://cdn.v2ex.com/avatar/c559/74de/588225_normal.png?m=1722676805", "avatar_large": "https://cdn.v2ex.com/avatar/c559/74de/588225_large.png?m=1722676805", "avatar_xlarge": "https://cdn.v2ex.com/avatar/c559/74de/588225_xlarge.png?m=1722676805", "avatar_xxlarge": "https://cdn.v2ex.com/avatar/c559/74de/588225_xlarge.png?m=1722676805", "avatar_xxxlarge": "https://cdn.v2ex.com/avatar/c559/74de/588225_xlarge.png?m=1722676805", "created": 1657958045, "last_modified": 1722676805}, "last_reply_by": "yegar", "last_touched": 1725155388, "title": "一件让我很焦虑的事情，想征求一下大家的看法。", "url": "https://www.v2ex.com/t/1069294", "created": 1725119277, "deleted": 0, "content": "事情是这样的，若干年前，那会儿我还是个刚满 18 岁的小孩，也拥有了人生第一台笔记本。\r\n\r\n当时的我对科技/程序这块非常感兴趣，也学着开始上外网，但是当时我囊中羞涩，于是特别喜欢开启网站内容（例如 Prime Video ）/电脑软件（例如 Vmware 或者 Funsion 或者 Adobe ，只是举个例子）的试用。在试用期结束之后往往就放着不管了。\r\n\r\n这也成了本次事件让我焦虑的核心。由于当时的我年纪不大，不懂什么“料卡”什么“一次性邮箱”这种概念，往往直接用自己的 QQ 邮箱/outlook/gmail 注册账户并开启试用。\r\n\r\n有些试用只需要绑定邮箱/验证手机号就可以使用，有些试用则需要绑定银行卡才行。当时，我手里有一张自己名下的跨境通 Visa 卡，于是就把自己的卡绑定上去了。\r\n\r\n由于我卡里长年不放钱（余额小于 1 美元），因此即使后续发生扣款，也是无法扣成功的。\r\n\r\n长大之后的我知道了不可以如此随便的开启试用（不能抱着白嫖的心态），但是感觉为时已晚，现在的我能做到的只能是把当时我开的那张跨境通 Visa 卡销户。\r\n\r\n因为目前我患有焦虑症，所以对自己十分敏感。我最近看到了 Adobe 的新闻，又让我感到十分内耗，害怕我未来因为之前白嫖试用的事情被清算。\r\n\r\n但是由于距离事发已经过去了三四年了，邮箱记录丢失，我的记忆也都十分模糊了，因此完全不记得我曾经开启过哪些试用。\r\n\r\n还有一点也很让我头疼，就是因为我记性不好，加上当时有多个邮箱。于是就经常会出现注册的时候用 Outlook 注册，过了一段时间登陆时候搞错用了 Google 登陆（相当于自动注册了一个新号）的乌龙。这导致往往同一个网站我可能有多个账号，或者有那种未完成注册（验证了邮箱，但是没输入信息）的账号。不知道大家会不会也有这样的经历？\r\n\r\n因此希望各位大佬能发表一下自己的看法，我的担心是不是有些太夸张了？\r\n后续如果真的有什么问题的话，对方会邮件通知我吗？", "content_rendered": "<p>事情是这样的，若干年前，那会儿我还是个刚满 18 岁的小孩，也拥有了人生第一台笔记本。</p>\n<p>当时的我对科技/程序这块非常感兴趣，也学着开始上外网，但是当时我囊中羞涩，于是特别喜欢开启网站内容（例如 Prime Video ）/电脑软件（例如 Vmware 或者 Funsion 或者 Adobe ，只是举个例子）的试用。在试用期结束之后往往就放着不管了。</p>\n<p>这也成了本次事件让我焦虑的核心。由于当时的我年纪不大，不懂什么“料卡”什么“一次性邮箱”这种概念，往往直接用自己的 QQ 邮箱/outlook/gmail 注册账户并开启试用。</p>\n<p>有些试用只需要绑定邮箱/验证手机号就可以使用，有些试用则需要绑定银行卡才行。当时，我手里有一张自己名下的跨境通 Visa 卡，于是就把自己的卡绑定上去了。</p>\n<p>由于我卡里长年不放钱（余额小于 1 美元），因此即使后续发生扣款，也是无法扣成功的。</p>\n<p>长大之后的我知道了不可以如此随便的开启试用（不能抱着白嫖的心态），但是感觉为时已晚，现在的我能做到的只能是把当时我开的那张跨境通 Visa 卡销户。</p>\n<p>因为目前我患有焦虑症，所以对自己十分敏感。我最近看到了 Adobe 的新闻，又让我感到十分内耗，害怕我未来因为之前白嫖试用的事情被清算。</p>\n<p>但是由于距离事发已经过去了三四年了，邮箱记录丢失，我的记忆也都十分模糊了，因此完全不记得我曾经开启过哪些试用。</p>\n<p>还有一点也很让我头疼，就是因为我记性不好，加上当时有多个邮箱。于是就经常会出现注册的时候用 Outlook 注册，过了一段时间登陆时候搞错用了 Google 登陆（相当于自动注册了一个新号）的乌龙。这导致往往同一个网站我可能有多个账号，或者有那种未完成注册（验证了邮箱，但是没输入信息）的账号。不知道大家会不会也有这样的经历？</p>\n<p>因此希望各位大佬能发表一下自己的看法，我的担心是不是有些太夸张了？\n后续如果真的有什么问题的话，对方会邮件通知我吗？</p>\n", "last_modified": 1725119277, "replies": 43, "id": 1069294}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/c20a/d4d7/12_large.png?m=1650095340", "name": "qna", "avatar_normal": "https://cdn.v2ex.com/navatar/c20a/d4d7/12_normal.png?m=1650095340", "title": "问与答", "url": "https://www.v2ex.com/go/qna", "topics": 222466, "footer": "", "header": "一个更好的世界需要你持续地提出好问题。", "title_alternative": "Questions and Answers", "avatar_mini": "https://cdn.v2ex.com/navatar/c20a/d4d7/12_mini.png?m=1650095340", "stars": 4229, "aliases": [], "root": false, "id": 12, "parent_node_name": "v2ex"}, "member": {"id": 551486, "username": "neuliyiping", "url": "https://www.v2ex.com/u/neuliyiping", "website": null, "twitter": null, "psn": null, "github": null, "btc": null, "location": null, "tagline": null, "bio": null, "avatar_mini": "https://cdn.v2ex.com/avatar/ced4/7707/551486_mini.png?m=1725088079", "avatar_normal": "https://cdn.v2ex.com/avatar/ced4/7707/551486_normal.png?m=1725088079", "avatar_large": "https://cdn.v2ex.com/avatar/ced4/7707/551486_large.png?m=1725088079", "avatar_xlarge": "https://cdn.v2ex.com/avatar/ced4/7707/551486_xlarge.png?m=1725088079", "avatar_xxlarge": "https://cdn.v2ex.com/avatar/ced4/7707/551486_xlarge.png?m=1725088079", "avatar_xxxlarge": "https://cdn.v2ex.com/avatar/ced4/7707/551486_xlarge.png?m=1725088079", "created": 1626923936, "last_modified": 1725088079}, "last_reply_by": "EndlessMemory", "last_touched": 1725134831, "title": "大家平时都逛哪些论坛？", "url": "https://www.v2ex.com/t/1069230", "created": 1725089016, "deleted": 0, "content": "平时就看看 V2EX 和阮一峰，想知道大家上班摸鱼刷都逛哪些有意思的论坛。", "content_rendered": "平时就看看 V2EX 和阮一峰，想知道大家上班摸鱼刷都逛哪些有意思的论坛。", "last_modified": 1725089016, "replies": 34, "id": 1069230}, {"node": {"avatar_large": "/static/img/node_default_large.png", "name": "fit", "avatar_normal": "/static/img/node_default_normal.png", "title": "健康", "url": "https://www.v2ex.com/go/fit", "topics": 1264, "footer": "", "header": "这个节点的设立，是为了让大家可以分享关于健身和健康生活方式的经验。如果你有什么正在困扰自己的身体症状，请立刻寻求正规医院的帮助。", "title_alternative": "Fit", "avatar_mini": "/static/img/node_default_mini.png", "stars": 350, "aliases": [], "root": false, "id": 700, "parent_node_name": "life"}, "member": {"id": 681599, "username": "wangshuo6", "url": "https://www.v2ex.com/u/wangshuo6", "website": null, "twitter": null, "psn": null, "github": null, "btc": null, "location": null, "tagline": null, "bio": null, "avatar_mini": "https://cdn.v2ex.com/gravatar/5651f159f5d4c21abf5e5930139795a0?s=24&d=retro", "avatar_normal": "https://cdn.v2ex.com/gravatar/5651f159f5d4c21abf5e5930139795a0?s=48&d=retro", "avatar_large": "https://cdn.v2ex.com/gravatar/5651f159f5d4c21abf5e5930139795a0?s=73&d=retro", "created": 1711192688, "last_modified": 1711192688}, "last_reply_by": "9", "last_touched": 1725129137, "title": "智齿导致口臭，哭了", "url": "https://www.v2ex.com/t/1069236", "created": 1725091451, "deleted": 0, "content": "有不拔智齿解决口臭的方法吗", "content_rendered": "<p>有不拔智齿解决口臭的方法吗</p>\n", "last_modified": 1725091451, "replies": 31, "id": 1069236}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/6e27/13a6/557_large.png?m=1608969785", "name": "life", "avatar_normal": "https://cdn.v2ex.com/navatar/6e27/13a6/557_normal.png?m=1608969785", "title": "生活", "url": "https://www.v2ex.com/go/life", "topics": 6253, "footer": "", "header": "生活中的技术讨论", "title_alternative": "Life", "avatar_mini": "https://cdn.v2ex.com/navatar/6e27/13a6/557_mini.png?m=1608969785", "stars": 1503, "aliases": [], "root": false, "id": 557, "parent_node_name": ""}, "member": {"id": 629304, "username": "Grayan", "url": "https://www.v2ex.com/u/Grayan", "website": "", "twitter": null, "psn": null, "github": null, "btc": null, "location": "", "tagline": "", "bio": "", "avatar_mini": "https://cdn.v2ex.com/avatar/e694/f27a/629304_mini.png?m=1715434060", "avatar_normal": "https://cdn.v2ex.com/avatar/e694/f27a/629304_normal.png?m=1715434060", "avatar_large": "https://cdn.v2ex.com/avatar/e694/f27a/629304_large.png?m=1715434060", "avatar_xlarge": "https://cdn.v2ex.com/avatar/e694/f27a/629304_xlarge.png?m=1715434060", "avatar_xxlarge": "https://cdn.v2ex.com/avatar/e694/f27a/629304_xlarge.png?m=1715434060", "created": 1684247628, "last_modified": 1715434060}, "last_reply_by": "simo", "last_touched": 1724761973, "title": "母亲今早遭遇交通事故，请教下事故判责相关问题？希望有过类似经历或法律从业者分享点经验。", "url": "https://www.v2ex.com/t/1069208", "created": 1725076765, "deleted": 0, "content": "事情起因：\r\n\t今早七八点收到我姐的电话，被告知母亲今早出车祸了。\r\n   \t\r\n目前我所了解到几点状况：\r\n1. 事故发生于乡间水泥路口，事故双方均为电动车，我母亲是正常的爱玛电动车，对方是很小的那种便携式电动自行车。过路口时双方应该都是直行，对方撞到了我妈车上，导致我妈摔车了。\r\n2. 伤势方面，我妈被撞了，伤势较严重，右手腕断了，左手血管断了，牙齿掉了三颗。对方应该无大碍。\r\n3. 发生事故后交通队出警了，但事故发生在乡间路上，交通队说这事或许判责事宜归派出所管，而判责方面说是让右原则，可能我妈 7 成，人家 3 成。\r\n\r\n请问下如果判责下来七三开合理吗？接下来有哪些方面需要注意的？", "content_rendered": "<p>事情起因：\n今早七八点收到我姐的电话，被告知母亲今早出车祸了。</p>\n<p>目前我所了解到几点状况：</p>\n<ol>\n<li>事故发生于乡间水泥路口，事故双方均为电动车，我母亲是正常的爱玛电动车，对方是很小的那种便携式电动自行车。过路口时双方应该都是直行，对方撞到了我妈车上，导致我妈摔车了。</li>\n<li>伤势方面，我妈被撞了，伤势较严重，右手腕断了，左手血管断了，牙齿掉了三颗。对方应该无大碍。</li>\n<li>发生事故后交通队出警了，但事故发生在乡间路上，交通队说这事或许判责事宜归派出所管，而判责方面说是让右原则，可能我妈 7 成，人家 3 成。</li>\n</ol>\n<p>请问下如果判责下来七三开合理吗？接下来有哪些方面需要注意的？</p>\n", "last_modified": 1725080475, "replies": 28, "id": 1069208}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/6e27/13a6/557_large.png?m=1608969785", "name": "life", "avatar_normal": "https://cdn.v2ex.com/navatar/6e27/13a6/557_normal.png?m=1608969785", "title": "生活", "url": "https://www.v2ex.com/go/life", "topics": 6253, "footer": "", "header": "生活中的技术讨论", "title_alternative": "Life", "avatar_mini": "https://cdn.v2ex.com/navatar/6e27/13a6/557_mini.png?m=1608969785", "stars": 1503, "aliases": [], "root": false, "id": 557, "parent_node_name": ""}, "member": {"id": 697779, "username": "muapyw", "url": "https://www.v2ex.com/u/muapyw", "website": null, "twitter": null, "psn": null, "github": null, "btc": null, "location": null, "tagline": null, "bio": null, "avatar_mini": "https://cdn.v2ex.com/gravatar/c3b5ffd62a46df826d79348d121ee0b2?s=24&d=retro", "avatar_normal": "https://cdn.v2ex.com/gravatar/c3b5ffd62a46df826d79348d121ee0b2?s=48&d=retro", "avatar_large": "https://cdn.v2ex.com/gravatar/c3b5ffd62a46df826d79348d121ee0b2?s=73&d=retro", "created": 1719239719, "last_modified": 1722193555}, "last_reply_by": "EndlessMemory", "last_touched": 1725135542, "title": "建议骑电动车办理驾照+交强险", "url": "https://www.v2ex.com/t/1069250", "created": 1725098498, "deleted": 0, "content": "前些年，电动车事故不会查驾照\r\n\r\n今年遇到的几个案子，电动车只要没有驾照的，不管是否有责任，都会安装无证驾驶负该负责，「几年前还不会这样」\r\n\r\n具体法规落地是否全国不太清除，大部分地方都开始了\r\n\r\n平时交警不会管，但是事故时候，无驾照会亏死哦", "content_rendered": "<p>前些年，电动车事故不会查驾照</p>\n<p>今年遇到的几个案子，电动车只要没有驾照的，不管是否有责任，都会安装无证驾驶负该负责，「几年前还不会这样」</p>\n<p>具体法规落地是否全国不太清除，大部分地方都开始了</p>\n<p>平时交警不会管，但是事故时候，无驾照会亏死哦</p>\n", "last_modified": 1725098498, "replies": 26, "id": 1069250}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/a5e0/0132/146_large.png?m=1650095218", "name": "js", "avatar_normal": "https://cdn.v2ex.com/navatar/a5e0/0132/146_normal.png?m=1650095218", "title": "JavaScript", "url": "https://www.v2ex.com/go/js", "topics": 3015, "footer": "", "header": "JavaScript (sometimes abbreviated JS) is a prototype-based scripting language that is dynamic, weakly typed and has first-class functions.", "title_alternative": "JavaScript", "avatar_mini": "https://cdn.v2ex.com/navatar/a5e0/0132/146_mini.png?m=1650095218", "stars": 3076, "aliases": [], "root": false, "id": 146, "parent_node_name": "programming"}, "member": {"id": 451595, "username": "llej", "url": "https://www.v2ex.com/u/llej", "website": "shenzilong.cn", "twitter": "", "psn": "", "github": "", "btc": "", "location": "", "tagline": "", "bio": "", "avatar_mini": "https://cdn.v2ex.com/avatar/b4e7/fabc/451595_mini.png?m=1596437487", "avatar_normal": "https://cdn.v2ex.com/avatar/b4e7/fabc/451595_normal.png?m=1596437487", "avatar_large": "https://cdn.v2ex.com/avatar/b4e7/fabc/451595_large.png?m=1596437487", "created": 1573092756, "last_modified": 1596437487}, "last_reply_by": "momo2789", "last_touched": 1725141052, "title": "如何实现一个小体积的 js docker 镜像", "url": "https://www.v2ex.com/t/1069239", "created": 1725093487, "deleted": 0, "content": "在服务端一般使用 node 来运行 js ，除了 node 外流行的还有 bun/deno 。\r\n\r\n但这三个运行时的打包体积都不小，在精简的情况下也在 50 mb 以上，我在这里记录一下我是如何将一个原来使用 node 开发的服务迁移为 3.78MB 的 docker 镜像。\r\n\r\n![image-20240831145324-mzsh9nq]( https://shenzilong.cn/assets/image-20240831145324-mzsh9nq.png)\r\n\r\n[https://hub.docker.com/layers/llej0/web-font/latest]( https://hub.docker.com/layers/llej0/web-font/latest/images/sha256-ebb8bb18d33844f27ca02d632c2ebf584435fffae28be2c9416baa86a8de45be?context=repo)\r\n\r\n## 选择 js 运行时 （[llrt]( https://github.com/awslabs/llrt)）\r\n\r\n要实现这么小的镜像肯定不能再使用 node 这种等级的 js 运行时了，现在最流行的轻量级 js 运行时可以锁定为 [QuickJS]( https://github.com/quickjs-zh/QuickJS)\r\n\r\n我要迁移的项目是我之前写的一个字体裁剪工具  [web-font]( https://github.com/2234839/web-font) , 它除了纯 js 的部分外还涉及到文件读写和 http server 部分的 api ，QuickJS 作为纯粹的解释器是没有这方面的 api 的。\r\n\r\n现有的比较成熟的基于 QuickJS 实现的微型 js 运行时有 [txiki.js]( https://github.com/saghul/txiki.js) 和 [llrt]( https://github.com/awslabs/llrt) , 经过实践发现 llrt 可以完美运行在 docker 中 ，txiki.js 则没那么方便 （按照文档编译出来的 tjs 还会依赖其他库）\r\n\r\n所以我选择使用 llrt 来作为运行时。\r\n\r\n## 迁移遇到的问题\r\n\r\n主要问题是 llrt 没有提供 http 模块（ tixiki.js 也是）, 幸运的是它提供了 net 模块\r\n\r\n所以我基于 net.createServer 手搓了一个[简易 http 服务]( https://github.com/2234839/web-font/blob/new/backend/server/tcp_server.ts)和洋葱路由 [server.ts]( https://github.com/2234839/web-font/blob/new/backend/server/server.ts) 。\r\n\r\n这期间还发现了 llrt 一个  cpu 占用异常：[https://github.com/awslabs/llrt/issues/546]( https://github.com/awslabs/llrt/issues/546)\r\n\r\n## 打包微小体积的 docker 镜像\r\n\r\n### 1. 代码打包\r\n\r\n这方面我使用的是 tsup 将 ts 源码打包为一个 js 文件。\r\n\r\n然后使用 llrt compile 命令将 js 文件编译为 .lrt 文件（这一步也能减少差不多 30%的体积）\r\n\r\n### 2. Dockerfile\r\n\r\n得益于 llrt ，可以不用依赖任何环境，直接使用 `FROM scratch` 来得到最小的 docker 镜像体积\r\n\r\n```dockerfile\r\nFROM scratch\r\nWORKDIR /home/\r\nCOPY dist_backend/app.lrt /home/app.lrt\r\nCOPY llrt /home/llrt\r\nCOPY dist/ /home/dist/\r\nCMD [\"/home/llrt\", \"/home/app.lrt\"]\r\n```\r\n\r\n再经过 docker 的压缩后就得到了 3.78MB 这个数字。\r\n\r\n## 使用情况\r\n\r\nllrt 的运行速度比 node 还是慢了许多，在我这个场景下它比 node 要慢上两倍，gc 的运行速度也要慢许多。\r\n\r\n但初始内存占用和启动速度是碾压 node 的。\r\n\r\n由于运行时还不是特别完善的问题，很容易踩坑，所以除非你急需压缩 js 的运行内存占用/冷启动速度或者和我一样就是想要这么做，还是建议直接使用 node 吧。", "content_rendered": "<p>在服务端一般使用 node 来运行 js ，除了 node 外流行的还有 bun/deno 。</p>\n<p>但这三个运行时的打包体积都不小，在精简的情况下也在 50 mb 以上，我在这里记录一下我是如何将一个原来使用 node 开发的服务迁移为 3.78MB 的 docker 镜像。</p>\n<p><img alt=\"image-20240831145324-mzsh9nq\" class=\"embedded_image\" loading=\"lazy\" referrerpolicy=\"no-referrer\" rel=\"noreferrer\" src=\"https://shenzilong.cn/assets/image-20240831145324-mzsh9nq.png\"/></p>\n<p><a href=\"https://hub.docker.com/layers/llej0/web-font/latest/images/sha256-ebb8bb18d33844f27ca02d632c2ebf584435fffae28be2c9416baa86a8de45be?context=repo\" rel=\"nofollow\">https://hub.docker.com/layers/llej0/web-font/latest</a></p>\n<h2>选择 js 运行时 （<a href=\"https://github.com/awslabs/llrt\" rel=\"nofollow\">llrt</a>）</h2>\n<p>要实现这么小的镜像肯定不能再使用 node 这种等级的 js 运行时了，现在最流行的轻量级 js 运行时可以锁定为 <a href=\"https://github.com/quickjs-zh/QuickJS\" rel=\"nofollow\">QuickJS</a></p>\n<p>我要迁移的项目是我之前写的一个字体裁剪工具  <a href=\"https://github.com/2234839/web-font\" rel=\"nofollow\">web-font</a> , 它除了纯 js 的部分外还涉及到文件读写和 http server 部分的 api ，QuickJS 作为纯粹的解释器是没有这方面的 api 的。</p>\n<p>现有的比较成熟的基于 QuickJS 实现的微型 js 运行时有 <a href=\"https://github.com/saghul/txiki.js\" rel=\"nofollow\">txiki.js</a> 和 <a href=\"https://github.com/awslabs/llrt\" rel=\"nofollow\">llrt</a> , 经过实践发现 llrt 可以完美运行在 docker 中 ，txiki.js 则没那么方便 （按照文档编译出来的 tjs 还会依赖其他库）</p>\n<p>所以我选择使用 llrt 来作为运行时。</p>\n<h2>迁移遇到的问题</h2>\n<p>主要问题是 llrt 没有提供 http 模块（ tixiki.js 也是）, 幸运的是它提供了 net 模块</p>\n<p>所以我基于 net.createServer 手搓了一个<a href=\"https://github.com/2234839/web-font/blob/new/backend/server/tcp_server.ts\" rel=\"nofollow\">简易 http 服务</a>和洋葱路由 <a href=\"https://github.com/2234839/web-font/blob/new/backend/server/server.ts\" rel=\"nofollow\">server.ts</a> 。</p>\n<p>这期间还发现了 llrt 一个  cpu 占用异常：<a href=\"https://github.com/awslabs/llrt/issues/546\" rel=\"nofollow\">https://github.com/awslabs/llrt/issues/546</a></p>\n<h2>打包微小体积的 docker 镜像</h2>\n<h3>1. 代码打包</h3>\n<p>这方面我使用的是 tsup 将 ts 源码打包为一个 js 文件。</p>\n<p>然后使用 llrt compile 命令将 js 文件编译为 .lrt 文件（这一步也能减少差不多 30%的体积）</p>\n<h3>2. Dockerfile</h3>\n<p>得益于 llrt ，可以不用依赖任何环境，直接使用 <code>FROM scratch</code> 来得到最小的 docker 镜像体积</p>\n<pre><code class=\"language-dockerfile\">FROM scratch\nWORKDIR /home/\nCOPY dist_backend/app.lrt /home/app.lrt\nCOPY llrt /home/llrt\nCOPY dist/ /home/dist/\nCMD [\"/home/llrt\", \"/home/app.lrt\"]\n</code></pre>\n<p>再经过 docker 的压缩后就得到了 3.78MB 这个数字。</p>\n<h2>使用情况</h2>\n<p>llrt 的运行速度比 node 还是慢了许多，在我这个场景下它比 node 要慢上两倍，gc 的运行速度也要慢许多。</p>\n<p>但初始内存占用和启动速度是碾压 node 的。</p>\n<p>由于运行时还不是特别完善的问题，很容易踩坑，所以除非你急需压缩 js 的运行内存占用/冷启动速度或者和我一样就是想要这么做，还是建议直接使用 node 吧。</p>\n", "last_modified": 1725093669, "replies": 21, "id": 1069239}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/4ea0/6fbc/770_large.png?m=1695370146", "name": "career", "avatar_normal": "https://cdn.v2ex.com/navatar/4ea0/6fbc/770_normal.png?m=1695370146", "title": "职场话题", "url": "https://www.v2ex.com/go/career", "topics": 17973, "footer": "", "header": "这里，我们聊聊那些工作中遇到的开心和不开心的事。", "title_alternative": "Career", "avatar_mini": "https://cdn.v2ex.com/navatar/4ea0/6fbc/770_mini.png?m=1695370146", "stars": 3220, "aliases": [], "root": false, "id": 770, "parent_node_name": "work"}, "member": {"id": 587199, "username": "1145148964", "url": "https://www.v2ex.com/u/1145148964", "website": "", "twitter": null, "psn": null, "github": null, "btc": null, "location": "", "tagline": "", "bio": "https://t.me/wangleishabi", "avatar_mini": "https://cdn.v2ex.com/gravatar/e2e572807688a5c9c2c02aa111fa7662?s=24&d=retro", "avatar_normal": "https://cdn.v2ex.com/gravatar/e2e572807688a5c9c2c02aa111fa7662?s=48&d=retro", "avatar_large": "https://cdn.v2ex.com/gravatar/e2e572807688a5c9c2c02aa111fa7662?s=73&d=retro", "created": 1657098521, "last_modified": 1676029899}, "last_reply_by": "capplenerv", "last_touched": 1725125661, "title": "楼主被从“中部省会”调到乌鲁木齐了。工资 1.5 倍。准备辞职了。", "url": "https://www.v2ex.com/t/1069255", "created": 1725100415, "deleted": 0, "content": "啥也不会啊。", "content_rendered": "啥也不会啊。", "last_modified": 1725100439, "replies": 21, "id": 1069255}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/70ef/df2e/17_large.png?m=1660301119", "name": "create", "avatar_normal": "https://cdn.v2ex.com/navatar/70ef/df2e/17_normal.png?m=1660301119", "title": "分享创造", "url": "https://www.v2ex.com/go/create", "topics": 24931, "footer": "", "header": "欢迎你在这里发布自己的最新作品！", "title_alternative": "Create", "avatar_mini": "https://cdn.v2ex.com/navatar/70ef/df2e/17_mini.png?m=1660301119", "stars": 5474, "aliases": [], "root": false, "id": 17, "parent_node_name": "geek"}, "member": {"id": 273665, "username": "JamesZHH", "url": "https://www.v2ex.com/u/JamesZHH", "website": null, "twitter": null, "psn": null, "github": null, "btc": null, "location": null, "tagline": null, "bio": null, "avatar_mini": "https://cdn.v2ex.com/avatar/881a/6da9/273665_mini.png?m=1715157569", "avatar_normal": "https://cdn.v2ex.com/avatar/881a/6da9/273665_normal.png?m=1715157569", "avatar_large": "https://cdn.v2ex.com/avatar/881a/6da9/273665_large.png?m=1715157569", "avatar_xlarge": "https://cdn.v2ex.com/avatar/881a/6da9/273665_xlarge.png?m=1715157569", "avatar_xxlarge": "https://cdn.v2ex.com/avatar/881a/6da9/273665_xlarge.png?m=1715157569", "created": 1512951735, "last_modified": 1715157569}, "last_reply_by": "bao3", "last_touched": 1725153038, "title": "受不了夸张的体积，业余时间写了一款原生的 iOS 地震通知 App", "url": "https://www.v2ex.com/t/1069274", "created": 1725110548, "deleted": 0, "content": "经历过 08 年大地震，加上常居四川，对地震信息比较敏感。\r\n\r\n之前一直用某款地震预警 App ，最近发现安装包体积已经 500 MB 了，于是抽业余时间写了一个原生 App 来查看地震信息和接收通知。\r\n\r\n第一次写 iOS App ，一开始只打算自用。但后面也想走一下 App Store 发布流程，就上架了。\r\n\r\n## 核心功能\r\n\r\n1. 全球主流数据源，包含：美国地质调查局（ USGS ）、欧洲地中海地震中心（ EMSC ）、中国地震台网中心（ CEIC ）、日本气象厅（ JMA ）、台湾中央气象局（ CWB ）等；\r\n2. 地震数据可视化，不同的地图样式，并提供地震详情；\r\n3. 地震数据洞察，了解一段时间的震情数据；\r\n4. 服务器端的地震通知，可以实现全球地震通知，无需打开 app ；\r\n5. SwiftUI 原生应用，无广告，无隐私忧虑。上手简单，易于使用；\r\n6. 针对 iPad 和 macOS 大屏幕适配；\r\n\r\n## 预览\r\n\r\n![]( https://cdn.huhuhang.com/images/2024/08/777shots_so.png)\r\n![]( https://cdn.huhuhang.com/images/2024/08/529shots_so.png)\r\n![]( https://cdn.huhuhang.com/images/2024/08/286shots_so.png)\r\n\r\n地震消息并不是每个人都需要或者习惯性关注，所以应用设为了一次性付费，国区是 18 元。\r\n\r\n用户规模可控，消息的触达及时性就会比较好。\r\n\r\n由于我自己也是用户，所以会持续维护，这样付费用户也会有更好的体验。接下来主要的方向：\r\n\r\n1. 接入 Critical Alerts ，权限 Apple 还在审核；\r\n2. 在细节，稳定性，及时性上继续优化；\r\n3. 接入更多数据源，在数据方面继续深挖；\r\n\r\n如果你对地震信息感兴趣，可以 [试试 QuakeSense 震感]( https://apps.apple.com/app/quakesense/id6630381970)，也欢迎提出建议。\r\n\r\n顺便用 Tailwind CSS 写了一个网站： https://quakesense.app/\r\n\r\n再次感叹 Tailwind CSS 真好用。", "content_rendered": "<p>经历过 08 年大地震，加上常居四川，对地震信息比较敏感。</p>\n<p>之前一直用某款地震预警 App ，最近发现安装包体积已经 500 MB 了，于是抽业余时间写了一个原生 App 来查看地震信息和接收通知。</p>\n<p>第一次写 iOS App ，一开始只打算自用。但后面也想走一下 App Store 发布流程，就上架了。</p>\n<h2>核心功能</h2>\n<ol>\n<li>全球主流数据源，包含：美国地质调查局（ USGS ）、欧洲地中海地震中心（ EMSC ）、中国地震台网中心（ CEIC ）、日本气象厅（ JMA ）、台湾中央气象局（ CWB ）等；</li>\n<li>地震数据可视化，不同的地图样式，并提供地震详情；</li>\n<li>地震数据洞察，了解一段时间的震情数据；</li>\n<li>服务器端的地震通知，可以实现全球地震通知，无需打开 app ；</li>\n<li>SwiftUI 原生应用，无广告，无隐私忧虑。上手简单，易于使用；</li>\n<li>针对 iPad 和 macOS 大屏幕适配；</li>\n</ol>\n<h2>预览</h2>\n<p><img alt=\"\" class=\"embedded_image\" loading=\"lazy\" referrerpolicy=\"no-referrer\" rel=\"noreferrer\" src=\"https://cdn.huhuhang.com/images/2024/08/777shots_so.png\"/>\n<img alt=\"\" class=\"embedded_image\" loading=\"lazy\" referrerpolicy=\"no-referrer\" rel=\"noreferrer\" src=\"https://cdn.huhuhang.com/images/2024/08/529shots_so.png\"/>\n<img alt=\"\" class=\"embedded_image\" loading=\"lazy\" referrerpolicy=\"no-referrer\" rel=\"noreferrer\" src=\"https://cdn.huhuhang.com/images/2024/08/286shots_so.png\"/></p>\n<p>地震消息并不是每个人都需要或者习惯性关注，所以应用设为了一次性付费，国区是 18 元。</p>\n<p>用户规模可控，消息的触达及时性就会比较好。</p>\n<p>由于我自己也是用户，所以会持续维护，这样付费用户也会有更好的体验。接下来主要的方向：</p>\n<ol>\n<li>接入 Critical Alerts ，权限 Apple 还在审核；</li>\n<li>在细节，稳定性，及时性上继续优化；</li>\n<li>接入更多数据源，在数据方面继续深挖；</li>\n</ol>\n<p>如果你对地震信息感兴趣，可以 <a href=\"https://apps.apple.com/app/quakesense/id6630381970\" rel=\"nofollow\">试试 QuakeSense 震感</a>，也欢迎提出建议。</p>\n<p>顺便用 Tailwind CSS 写了一个网站： <a href=\"https://quakesense.app/\" rel=\"nofollow\">https://quakesense.app/</a></p>\n<p>再次感叹 Tailwind CSS 真好用。</p>\n", "last_modified": 1725110548, "replies": 20, "id": 1069274}]