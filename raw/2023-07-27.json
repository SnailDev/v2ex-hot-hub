[{"node": {"avatar_large": "https://cdn.v2ex.com/navatar/c20a/d4d7/12_large.png?m=1650095340", "name": "qna", "avatar_normal": "https://cdn.v2ex.com/navatar/c20a/d4d7/12_normal.png?m=1650095340", "title": "问与答", "url": "https://www.v2ex.com/go/qna", "topics": 207785, "footer": "", "header": "一个更好的世界需要你持续地提出好问题。", "title_alternative": "Questions and Answers", "avatar_mini": "https://cdn.v2ex.com/navatar/c20a/d4d7/12_mini.png?m=1650095340", "stars": 3886, "aliases": [], "root": false, "id": 12, "parent_node_name": "v2ex"}, "member": {"id": 473158, "username": "PingAn66", "url": "https://www.v2ex.com/u/PingAn66", "website": null, "twitter": null, "psn": null, "github": null, "btc": null, "location": null, "tagline": null, "bio": null, "avatar_mini": "https://cdn.v2ex.com/avatar/0950/7ab7/473158_mini.png?m=1672900287", "avatar_normal": "https://cdn.v2ex.com/avatar/0950/7ab7/473158_normal.png?m=1672900287", "avatar_large": "https://cdn.v2ex.com/avatar/0950/7ab7/473158_large.png?m=1672900287", "avatar_xlarge": "https://cdn.v2ex.com/avatar/0950/7ab7/473158_xlarge.png?m=1672900287", "created": 1582944484, "last_modified": 1672900287}, "last_reply_by": "yianing", "last_touched": 1690445127, "title": "朋友们，如何解读 7.24 号的经济会议？小城市要开始棚户改造了吗？如果落实顺利的话，那别的中国的中大型城市房价还会再起飞一波吗？", "url": "https://www.v2ex.com/t/960065", "created": 1690417119, "deleted": 0, "content": ":(", "content_rendered": "<p>:(</p>\n", "last_modified": 1690417212, "replies": 297, "id": 960065}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/c20a/d4d7/12_large.png?m=1650095340", "name": "qna", "avatar_normal": "https://cdn.v2ex.com/navatar/c20a/d4d7/12_normal.png?m=1650095340", "title": "问与答", "url": "https://www.v2ex.com/go/qna", "topics": 207785, "footer": "", "header": "一个更好的世界需要你持续地提出好问题。", "title_alternative": "Questions and Answers", "avatar_mini": "https://cdn.v2ex.com/navatar/c20a/d4d7/12_mini.png?m=1650095340", "stars": 3886, "aliases": [], "root": false, "id": 12, "parent_node_name": "v2ex"}, "member": {"id": 486923, "username": "YVAN7123", "url": "https://www.v2ex.com/u/YVAN7123", "website": "", "twitter": null, "psn": null, "github": null, "btc": null, "location": "", "tagline": "", "bio": "", "avatar_mini": "https://cdn.v2ex.com/avatar/2faf/3b44/486923_mini.png?m=1620717280", "avatar_normal": "https://cdn.v2ex.com/avatar/2faf/3b44/486923_normal.png?m=1620717280", "avatar_large": "https://cdn.v2ex.com/avatar/2faf/3b44/486923_large.png?m=1620717280", "created": 1588123987, "last_modified": 1620717280}, "last_reply_by": "yazinnnn", "last_touched": 1690445014, "title": "特斯拉为啥卖的这么好？", "url": "https://www.v2ex.com/t/959951", "created": 1690362551, "deleted": 0, "content": "2023 年 6 月 销量中 Model 3\t22741 在同款中排第二。\r\n\r\n周围的人总是问我，为啥特斯拉卖的这么好？\r\n有没有大佬说一下，为啥呢", "content_rendered": "<p>2023 年 6 月 销量中 Model 3\t22741 在同款中排第二。</p>\n<p>周围的人总是问我，为啥特斯拉卖的这么好？\n有没有大佬说一下，为啥呢</p>\n", "last_modified": 1690362551, "replies": 141, "id": 959951}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/94f6/d7e0/300_large.png?m=1689070442", "name": "programmer", "avatar_normal": "https://cdn.v2ex.com/navatar/94f6/d7e0/300_normal.png?m=1689070442", "title": "程序员", "url": "https://www.v2ex.com/go/programmer", "topics": 57609, "footer": "", "header": "While code monkeys are not eating bananas, they're coding.", "title_alternative": "Programmer", "avatar_mini": "https://cdn.v2ex.com/navatar/94f6/d7e0/300_mini.png?m=1689070442", "stars": 8501, "aliases": [], "root": false, "id": 300, "parent_node_name": "computer"}, "member": {"id": 600788, "username": "johnlanni", "url": "https://www.v2ex.com/u/johnlanni", "website": null, "twitter": null, "psn": null, "github": null, "btc": null, "location": null, "tagline": null, "bio": null, "avatar_mini": "https://cdn.v2ex.com/avatar/0a06/c2f1/600788_mini.png?m=1680062003", "avatar_normal": "https://cdn.v2ex.com/avatar/0a06/c2f1/600788_normal.png?m=1680062003", "avatar_large": "https://cdn.v2ex.com/avatar/0a06/c2f1/600788_large.png?m=1680062003", "avatar_xlarge": "https://cdn.v2ex.com/avatar/0a06/c2f1/600788_xlarge.png?m=1680062003", "avatar_xxlarge": "https://cdn.v2ex.com/avatar/0a06/c2f1/600788_xlarge.png?m=1680062003", "created": 1667705670, "last_modified": 1680062003}, "last_reply_by": "lambdaq", "last_touched": 1689979138, "title": "2023 年了，你还在学 Nginx 吗", "url": "https://www.v2ex.com/t/959994", "created": 1690370799, "deleted": 0, "content": "## Higress 介绍\r\n\r\n[Higress]( https://github.com/alibaba/higress) 是基于阿里巴巴内部两年多的 Envoy Gateway 实践沉淀，以开源 Istio 与 Envoy 为核心构建的下一代云原生网关。Higress 实现了安全防护网关、流量网关、微服务网关三层网关合一，可以显著降低网关的部署和运维成本。\r\n\r\n官网地址： https://higress.cn\r\n\r\nGitHub 地址： https://github.com/alibaba/higress\r\n\r\n\r\nHigress 作为云原生网关的核心优势如下：\r\n\r\n### 易用性\r\n\r\n“云原生”已经不再是一个新鲜词，但企业对云原生技术的学习使用成本仍有许多顾虑，对云原生新标准的追赶又有很多焦虑；\r\n\r\nHigress 同时提供了本地安装/生产部署的 quickstart ，可以一键部署，并通过控制台操作快速上手；基于简单易用的控制台，Higress 可以封装 Ingress/Gateway API 的标准细节，根治技术追赶焦虑。\r\n\r\n### 标准化\r\n\r\nK8s 带来了云原生的路由标准 Ingress/Gateway API ，如同 POSIX 定义 Unix 可移植操作系统标准，历时 35 年经久不衰，云原生的路由标准的生命周期一定会远超过 K8s 本身；\r\n\r\nHigress 结合阿里内部实践以及阿里云产品沉淀，积累了基于 Ingress API 的丰富的路由策略扩展能力，同时还兼容大部分 Nginx Ingress 能力，这些能力后续也将在 Gateway API 上支持。\r\n\r\n### 高集成\r\n\r\n企业内有大量传统架构部署的服务，会成为向云原生架构演进的技术负担，要求云原生网关具备对接异构服务架构的能力；\r\n\r\n基于 Higress 提供的多种服务发现机制，网关路由不仅可以转发到 K8s 服务，也可以直接配置 IP 转发到到物理机上的服务；基于 Nacos/ZooKeeper 等注册中心对接，还可以轻松实现 Spring Cloud 和 Dubbo 微服务的路由，无论其是否部署在 K8s 内。\r\n\r\n### 易扩展\r\n\r\n基于扩展机制进行二次开发的能力，是云原生网关在不同业务场景下都能适配落地的关键；\r\n\r\nHigress 提供了灵活的插件扩展机制，目前插件市场已经推出多个官方插件，并支持用户通过控制台直接上传自己开发的插件，同时开源社区的插件市场生态也在不断建设中。\r\n\r\n### 热更新\r\n\r\n传统 Nginx 更新规则需要 reload 会导致链接抖动，导致流量损失，对实时通信、视频、IOT 无法容忍；\r\n\r\n对于路由规则，Wasm 插件逻辑更新，以及证书改动等等，Higress 全部支持热更新，不会造成任何连接抖动。\r\n\r\n\r\n## Higress 全局配置\r\n\r\n下文将介绍 Higress 全局配置控制面实现机制，Higress 数据面基于 Envoy 是 C++ 语言开发，控制面则是基于 Go 语言开发。控制面的开发上手门槛还是很低的，欢迎有更多同学参与贡献。社区也有多个学习兴趣小组，欢迎加入学习： https://github.com/alibaba/higress/issues?q=is%3Aopen+is%3Aissue+label%3A%22learning+to+share%22\r\n\r\n\r\nHigress 有个全局配置 ConfigMap 对象 higress-config ，参考配置如下：\r\n\r\n```yaml\r\napiVersion: v1\r\ndata:\r\n  higress: |-\r\n    tracing:\r\n      enable: true\r\n      sampling: 100\r\n      timeout: 500\r\n      skywalking:\r\n       service: skywalking-oap-server.op-system.svc.cluster.local\r\n       port: 11800\r\n...\r\n...\r\nkind: ConfigMap\r\nmetadata:\r\n  name: higress-config\r\n  namespace: higress-system\r\n```\r\n\r\n具体配置说明请参考 [Higress 全局配置说明文档]( https://higress.io/zh-cn/docs/user/configmap)，\r\n本文介绍以 Tracing 为例，详细说明 Tracing 全局配置是如何转成 EnvoyFilter 和如何同时实现实时下发到 Higress Gateway 过程。\r\n\r\n本文涉及整体架构流程、初始化过程和启动、higress-config 变更和处理流程、通知 XDSUpdater 、构建 EnvoyFilter 和下发以及如何扩展全局配置等内容。\r\n\r\n## 整体架构流程\r\n\r\n### 1. 整体架构\r\n\r\n![img.png]( https://higress.io/zh-cn/assets/images/configmap1-f2447fa1bd9826e78e29bcdf1f38a4ca.png)\r\n\r\n\r\n### 2. 核心组件\r\n\r\n- IngressConfig\r\n\r\nIngressConfig 是 Higress 一个核心结构体, 负责监控 Ingress ，McpBridge, Http2Rpc, WasmPlugin 等 k8s 资源， 同时集成 ConfigStore Interface ，通过 List 接口下发 VirtualService, DestinationRule, EnvoyFilter, ServiceEntry, WasmPlugin 等 CR 资源。\r\n\r\n- ConfigmapMgr\r\n\r\nConfigmapMgr 结构体负责整个核心流程，包括通过 Informer List/Watch 机制监控 higress-config 的变更，同时遍历 ItemControllers 下发变更通知，提供构建 EnvoyFilter 列表等功能。\r\n\r\n- TracingController\r\n\r\nTracingController 结构体负责具体的 Tracing 数据校验，构建 Tracing EnvoyFilter, 以及通过 ItemEventHandler 下发变更通知等。\r\n\r\n- HigressConfig\r\n \r\nHigressConfig 是 higress-config Configmap 所对应数据的结构体。\r\n\r\n\r\n### 3. 核心流程\r\n\r\n- 用 Informer List/Watch 机制监控 higress-config 变更，校验变更，同时保存变更后数据。\r\n- 用变更数据构建 EnvoyFilter 。\r\n- 通知 XDSUpdater ，EnvoyFilter 有变更，重新拉取新的 EnvoyFilter 列表。\r\n\r\n## 初始化过程\r\n\r\n### 1. 初始化入口\r\n\r\n初始化过程入口在 NewIngressConfig ， 初始化 IngressConfig 时同时构建 HigressConfigController 和 ConfigmapMgr 。\r\n\r\n```golang\r\n// pkg/ingress/config/ingress_config.go\r\nfunc NewIngressConfig(localKubeClient kube.Client, XDSUpdater model.XDSUpdater, namespace, clusterId string) *IngressConfig {\r\n\t// ...\r\n\t\r\n\t// 构建 controller 和 configmapMgr\r\n\thigressConfigController := configmap.NewController(localKubeClient, clusterId, namespace)\r\n\tconfig.configmapMgr = configmap.NewConfigmapMgr(XDSUpdater, namespace, higressConfigController, higressConfigController.Lister())\r\n\r\n\treturn config\r\n}\r\n```\r\n\r\n### 2. HigressConfigController 初始化\r\n\r\n通过 Higress 提供 NewCommonController 初始化 HigressConfigController 用于监听 higress-system 命名空间下 Configmap 的变化。\r\n\r\n```golang\r\n// pkg/ingress/kube/configmap/controller.go\r\ntype HigressConfigController controller.Controller[listersv1.ConfigMapNamespaceLister]\r\n\r\nfunc NewController(client kubeclient.Client, clusterId string, namespace string) HigressConfigController {\r\n\tinformer := client.KubeInformer().Core().V1().ConfigMaps().Informer()\r\n\treturn controller.NewCommonController(\"higressConfig\", client.KubeInformer().Core().V1().ConfigMaps().Lister().ConfigMaps(namespace),\r\n\t\tinformer, GetConfigmap, clusterId)\r\n}\r\n\r\nfunc GetConfigmap(lister listersv1.ConfigMapNamespaceLister, namespacedName types.NamespacedName) (controllers.Object, error) {\r\n\treturn lister.Get(namespacedName.Name)\r\n}\r\n```\r\n### 3. ConfigmapMgr 初始化\r\n\r\nConfigmapMgr 初始化具体步骤如下：\r\n- 构建 ConfigmapMgr\r\n- 设置 HigressConfigController configmap 新增或者更新回调函数为 configmapMgr.AddOrUpdateHigressConfig\r\n- 设置 HigressConfig 结构体默认值\r\n- 初始化 TracingController\r\n- 把 tracingController 添加到 configmapMgr itemControllers 数组里\r\n- 初始化 ItemEventHandler ， 同时遍历 itemControllers ，设置 ItemEventHandler\r\n\r\n```golang\r\n// pkg/ingress/kube/configmap/controller.go\r\nfunc NewConfigmapMgr(XDSUpdater model.XDSUpdater, namespace string, higressConfigController HigressConfigController, higressConfigLister listersv1.ConfigMapNamespaceLister) *ConfigmapMgr {\r\n    //  构建 ConfigmapMgr\r\n\tconfigmapMgr := &ConfigmapMgr{\r\n\t\tXDSUpdater:              XDSUpdater,\r\n\t\tNamespace:               namespace,\r\n\t\tHigressConfigController: higressConfigController,\r\n\t\tHigressConfigLister:     higressConfigLister,\r\n\t\thigressConfig:           atomic.Value{},\r\n\t}\r\n\t// 设置 HigressConfigController configmap 新增或者更新回调函数 configmapMgr.AddOrUpdateHigressConfig\r\n\tconfigmapMgr.HigressConfigController.AddEventHandler(configmapMgr.AddOrUpdateHigressConfig)\r\n\t// 设置 HigressConfig 结构体默认值\r\n\tconfigmapMgr.SetHigressConfig(NewDefaultHigressConfig())\r\n\r\n\t// 初始化 TracingController\r\n\ttracingController := NewTracingController(namespace)\r\n\t// 把 tracingController 添加到 configmapMgr itemControllers 里\r\n\tconfigmapMgr.AddItemControllers(tracingController)\r\n\t// 初始化 itemEventHandler ， 同时遍历 itemControllers ，设置 itemEventHandler\r\n\tconfigmapMgr.initEventHandlers()\r\n\r\n\t// 返回 configmapMgr\r\n\treturn configmapMgr\r\n}\r\n```\r\n\r\n## 启动\r\n\r\n在 IngressConfig 添加 HigressConfigController Run() 和 HasSynced() 控制流程。\r\n\r\n```golang\r\n// pkg/ingress/config/ingress_config.go\r\nfunc (m *IngressConfig) Run(stop <-chan struct{}) {\r\n\t// ...\r\n\t// 启动 HigressConfigController\r\n\tgo m.configmapMgr.HigressConfigController.Run(stop)\r\n}\r\n\r\nfunc (m *IngressConfig) HasSynced() bool {\r\n\t// ....\r\n\tif !m.configmapMgr.HigressConfigController.HasSynced() {\r\n\t\treturn false\r\n\t}\r\n}\r\n```\r\n\r\n## higress-config 变更和处理流程\r\n\r\n### 1. configmapMgr 变更处理\r\n\r\nConfigmapMgr 通过收到 HigressConfigController 通知来处理变更请求。\r\n\r\n具体变更流程如下：\r\n- 判断是否 higress-system 命名空间下 name 为 higress-config Configmap 发生了变化，如果不是就返回。\r\n- 获取 higress-config 内容。\r\n- 遍历 ItemControllers, 校验 higress-config 配置是否合法，如果有一个返回不合法，就返回。\r\n- 和上次保存在本地 higressConfig 比对, 检查这次数据是否有变化，如果没有变化就返回。\r\n- 如果数据有变化，就遍历 ItemControllers 通知每个 itemController 数据有变化，同时保存这次变化到本地 higressConfig 。\r\n\r\n```golang\r\n// pkg/ingress/kube/configmap/controller.go\r\nfunc (c *ConfigmapMgr) AddOrUpdateHigressConfig(name util.ClusterNamespacedName) {\r\n\t// 只监听 higress-system 命名空间下 name 为 higress-config Configmap 的变化\r\n\tif name.Namespace != c.Namespace || name.Name != HigressConfigMapName {\r\n\t\treturn\r\n\t}\r\n    // ...\r\n\t// 获取 higress-config 内容\r\n\thigressConfigmap, err := c.HigressConfigLister.Get(HigressConfigMapName)\r\n\t\r\n\t// 通过 yaml.Unmarshal 转成 HigressConfig\r\n\tnewHigressConfig := NewDefaultHigressConfig()\r\n\tif err = yaml.Unmarshal([]byte(higressConfigmap.Data[HigressConfigMapKey]), newHigressConfig); err != nil {\r\n\t\tIngressLog.Errorf(\"data:%s,  convert to higress config error, error: %+v\", higressConfigmap.Data[HigressConfigMapKey], err)\r\n\t\treturn\r\n\t}\r\n\r\n\t// ...\r\n\t// 遍历 ItemControllers, 校验配置是否合法\r\n\tfor _, itemController := range c.ItemControllers {\r\n\t\tif itemErr := itemController.ValidHigressConfig(newHigressConfig); itemErr != nil {\r\n\t\t\tIngressLog.Errorf(\"configmap %s controller valid higress config error, error: %+v\", itemController.GetName(), itemErr)\r\n\t\t\treturn\r\n\t\t}\r\n\t}\r\n\r\n\t// 和上次比对这次数据是否有变更\r\n\toldHigressConfig := c.GetHigressConfig()\r\n\tresult, _ := c.CompareHigressConfig(oldHigressConfig, newHigressConfig)\r\n    // ...\r\n\t// 如果数据有变更，就遍历 ItemControllers 通知每个 itemController 数据有变更，同时保存这次变更到本地。\r\n\tif result == ResultReplace || result == ResultDelete {\r\n\t\tfor _, itemController := range c.ItemControllers {\r\n\t\t\tIngressLog.Infof(\"configmap %s controller AddOrUpdateHigressConfig\", itemController.GetName())\r\n\t\t\tif itemErr := itemController.AddOrUpdateHigressConfig(name, oldHigressConfig, newHigressConfig); itemErr != nil {\r\n\t\t\t\tIngressLog.Errorf(\"configmap %s controller AddOrUpdateHigressConfig error, error: %+v\", itemController.GetName(), itemErr)\r\n\t\t\t}\r\n\t\t}\r\n\t\t// 保存这次变更\r\n\t\tc.SetHigressConfig(newHigressConfig)\r\n\t}\r\n}\r\n```\r\n\r\n### 2. TracingController 变更处理\r\n\r\nTracingController 变更处理就比较简单：\r\n- 检查 Tracing 这部分数据是否有变更。\r\n- 如果有变更，DeepCopy 一份 Tracing 数据保存到本地，同时通过 eventHandler 下发变更通知。\r\n\r\n```golang\r\n// pkg/ingress/kube/configmap/tracing.go\r\nfunc (t *TracingController) AddOrUpdateHigressConfig(name util.ClusterNamespacedName, old *HigressConfig, new *HigressConfig) error {\r\n\t// ...\r\n\t// 检查 Tracing 部分数据是否有变更\r\n\tresult, _ := compareTracing(old.Tracing, new.Tracing)\r\n\r\n\t// 如果有变更，DeepCopy 一份 Tracing 数据保存到本地，同时通过 eventHandler 下发变更通知\r\n\tswitch result {\r\n\tcase ResultReplace:\r\n\t\tif newTracing, err := deepCopyTracing(new.Tracing); err != nil {\r\n\t\t\tIngressLog.Infof(\"tracing deepcopy error:%v\", err)\r\n\t\t} else {\r\n\t\t\tt.SetTracing(newTracing)\r\n\t\t\tIngressLog.Infof(\"AddOrUpdate Higress config tracing\")\r\n\t\t\tt.eventHandler(higressTracingEnvoyFilterName)\r\n\t\t\tIngressLog.Infof(\"send event with filter name:%s\", higressTracingEnvoyFilterName)\r\n\t\t}\r\n\tcase ResultDelete:\r\n\t\tt.SetTracing(NewDefaultTracing())\r\n\t\tIngressLog.Infof(\"Delete Higress config tracing\")\r\n\t\tt.eventHandler(higressTracingEnvoyFilterName)\r\n\t\tIngressLog.Infof(\"send event with filter name:%s\", higressTracingEnvoyFilterName)\r\n\t}\r\n\r\n\treturn nil\r\n}\r\n```\r\n\r\n## 通知 XDSUpdater\r\n\r\n在 ConfigmapMgr 初始化时候调用 configmapMgr.initEventHandlers()， 这个 func 会创建 ItemEventHandler, 同时遍历 ItemControllers 设置 ItemEventHandler 。\r\n\r\n```golang\r\n// pkg/ingress/kube/configmap/config.go\r\ntype ItemEventHandler = func(name string)\r\n\r\n// pkg/ingress/kube/configmap/controller.go\r\nfunc (c *ConfigmapMgr) initEventHandlers() error {\r\n    itemEventHandler := func(name string) {\r\n    c.XDSUpdater.ConfigUpdate(&model.PushRequest{\r\n        Full: true,\r\n        ConfigsUpdated: map[model.ConfigKey]struct{}{{\r\n            Kind:      gvk.EnvoyFilter,\r\n            Name:      name,\r\n            Namespace: c.Namespace,\r\n        }: {}},\r\n        Reason: []model.TriggerReason{ModelUpdatedReason},\r\n        })\r\n    }\r\n    \r\n    for _, itemController := range c.ItemControllers {\r\n\t\titemController.RegisterItemEventHandler(itemEventHandler)\r\n    }\r\n    \r\n    return nil\r\n}\r\n```\r\n\r\n这里 XDSUpdater 是从 IngressConfig 初始化传入，XDSUpdater.ConfigUpdate() 用于更新通知下发。\r\n\r\n进一步跟踪可以发现在 Higress controller server 启动时执行 s.initXdsServer 函数创建 s.xdsServer ，具体逻辑不在本文讨论范围, 有兴趣可以进一步阅读源码。\r\n\r\n\r\n```golang\r\n// pkg/bootstrap/server.go\r\nfunc NewServer(args *ServerArgs) (*Server, error) {\r\n\t// ...\r\n\ts := &Server{\r\n\t\tServerArgs:      args,\r\n\t\thttpMux:         http.NewServeMux(),\r\n\t\tenvironment:     e,\r\n\t\treadinessProbes: make(map[string]readinessProbe),\r\n\t\tserver:          server.New(),\r\n\t}\r\n\ts.environment.Watcher = mesh.NewFixedWatcher(&v1alpha1.MeshConfig{})\r\n\ts.environment.Init()\r\n\tinitFuncList := []func() error{\r\n\t\ts.initKubeClient,\r\n\t\ts.initXdsServer,\r\n\t\ts.initHttpServer,\r\n\t\ts.initConfigController,\r\n\t\ts.initRegistryEventHandlers,\r\n\t\ts.initAuthenticators,\r\n\t}\r\n\r\n\tfor _, f := range initFuncList {\r\n\t\tif err := f(); err != nil {\r\n\t\t\treturn nil, err\r\n\t\t}\r\n\t}\r\n\r\n\t// ...\r\n\treturn s, nil\r\n}\r\n\r\n// pkg/bootstrap/server.go\r\nfunc (s *Server) initXdsServer() error {\r\n    log.Info(\"init xds server\")\r\n    s.xdsServer = xds.NewDiscoveryServer(s.environment, nil, PodName, PodNamespace, s.RegistryOptions.KubeOptions.ClusterAliases)\r\n    // ...\r\n    return s.initGrpcServer()\r\n}\r\n```\r\n\r\n## 构建和下发 EnvoyFilters\r\n\r\n### 1. IngressConfig List 下发 EnvoyFilters 列表\r\n\r\nIngressConfig List 用于 VirtualService, DestinationRule, EnvoyFilter, ServiceEntry, WasmPlugin 等 CR 资源下发， 这里主要关注 EnvoyFilter CR 资源下发。\r\n\r\n```golang\r\n// pkg/ingress/config/ingress_config.go\r\nfunc (m *IngressConfig) List(typ config.GroupVersionKind, namespace string) ([]config.Config, error) {\r\n\tif typ != gvk.Gateway &&\r\n\t\ttyp != gvk.VirtualService &&\r\n\t\ttyp != gvk.DestinationRule &&\r\n\t\ttyp != gvk.EnvoyFilter &&\r\n\t\ttyp != gvk.ServiceEntry &&\r\n\t\ttyp != gvk.WasmPlugin {\r\n\t\treturn nil, common.ErrUnsupportedOp\r\n\t}\r\n\t// ...\r\n\tif typ == gvk.EnvoyFilter {\r\n\t\tm.mutex.RLock()\r\n\t\tdefer m.mutex.RUnlock()\r\n\t\tvar envoyFilters []config.Config\r\n\t\t\r\n\t\t// 调用 ConfigmapMgr ConstructEnvoyFilters 获取需要下发 EnvoyFilter 列表\r\n\t\tconfigmapEnvoyFilters, err := m.configmapMgr.ConstructEnvoyFilters()\r\n\t\tif err != nil {\r\n\t\t\tIngressLog.Errorf(\"Construct configmap EnvoyFilters error %v\", err)\r\n\t\t} else {\r\n\t\t\tfor _, envoyFilter := range configmapEnvoyFilters {\r\n\t\t\t\tenvoyFilters = append(envoyFilters, *envoyFilter)\r\n\t\t\t}\r\n\t\t\tIngressLog.Infof(\"Append %d configmap EnvoyFilters\", len(configmapEnvoyFilters))\r\n\t\t}\r\n\t\tif len(envoyFilters) == 0 {\r\n\t\t\tIngressLog.Infof(\"resource type %s, configs number %d\", typ, len(m.cachedEnvoyFilters))\r\n\t\t\treturn m.cachedEnvoyFilters, nil\r\n\t\t}\r\n\t\t// 需要下发 configmap EnvoyFilter 列表 和 m.cachedEnvoyFilters 列表聚合一下下发\r\n\t\tenvoyFilters = append(envoyFilters, m.cachedEnvoyFilters...)\r\n\t\tIngressLog.Infof(\"resource type %s, configs number %d\", typ, len(envoyFilters))\r\n\t\treturn envoyFilters, nil\r\n\t}\r\n\t\r\n}\t\r\n```\r\n\r\n调用 ConfigmapMgr ConstructEnvoyFilters 获取需要下发 EnvoyFilter 列表， 同时和 m.cachedEnvoyFilters 列表聚合一下再下发。\r\n\r\n这里 m.cachedEnvoyFilters 是在构建 VirtualService 时生成，有兴趣可以进一步阅读 IngressConfig 源码。\r\n\r\n\r\n### 2. ConfigmapMgr 构建 EnvoyFilter 列表\r\n\r\n这里比较简单，遍历一下 ItemControllers ，聚合每个 itemController 返回的 EnvoyFilters.\r\n\r\n```golang\r\n// /pkg/ingress/kube/configmap/controller.go\r\nfunc (c *ConfigmapMgr) ConstructEnvoyFilters() ([]*config.Config, error) {\r\n\tconfigs := make([]*config.Config, 0)\r\n\tfor _, itemController := range c.ItemControllers {\r\n\t\tIngressLog.Infof(\"controller %s ConstructEnvoyFilters\", itemController.GetName())\r\n\t\tif itemConfigs, err := itemController.ConstructEnvoyFilters(); err != nil {\r\n\t\t\tIngressLog.Errorf(\"controller %s ConstructEnvoyFilters error, error: %+v\", itemController.GetName(), err)\r\n\t\t} else {\r\n\t\t\tconfigs = append(configs, itemConfigs...)\r\n\t\t}\r\n\t}\r\n\treturn configs, nil\r\n}\r\n```\r\n\r\n### 3. TracingController 构建 EnvoyFilters\r\n\r\n这里就比较简单，根据保存的 Tracing 数据构建对应的 EnvoyFilter\r\n\r\n```golang\r\n// pkg/ingress/kube/configmap/tracing.go\r\nfunc (t *TracingController) ConstructEnvoyFilters() ([]*config.Config, error) {\r\n\t// ...\r\n\ttracingConfig := t.constructTracingTracer(tracing, namespace)\r\n\tif len(tracingConfig) == 0 {\r\n\t\treturn configs, nil\r\n\t}\r\n\r\n\tconfig := &config.Config{\r\n\t\tMeta: config.Meta{\r\n\t\t\tGroupVersionKind: gvk.EnvoyFilter,\r\n\t\t\tName:             higressTracingEnvoyFilterName,\r\n\t\t\tNamespace:        namespace,\r\n\t\t},\r\n\t\tSpec: &networking.EnvoyFilter{\r\n\t\t\tConfigPatches: []*networking.EnvoyFilter_EnvoyConfigObjectPatch{\r\n\t\t\t\t{\r\n\t\t\t\t\tApplyTo: networking.EnvoyFilter_NETWORK_FILTER,\r\n\t\t\t\t\tMatch: &networking.EnvoyFilter_EnvoyConfigObjectMatch{\r\n\t\t\t\t\t\tContext: networking.EnvoyFilter_GATEWAY,\r\n\t\t\t\t\t\tObjectTypes: &networking.EnvoyFilter_EnvoyConfigObjectMatch_Listener{\r\n\t\t\t\t\t\t\tListener: &networking.EnvoyFilter_ListenerMatch{\r\n\t\t\t\t\t\t\t\tFilterChain: &networking.EnvoyFilter_ListenerMatch_FilterChainMatch{\r\n\t\t\t\t\t\t\t\t\tFilter: &networking.EnvoyFilter_ListenerMatch_FilterMatch{\r\n\t\t\t\t\t\t\t\t\t\tName: \"envoy.filters.network.http_connection_manager\",\r\n\t\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t},\r\n\t\t\t\t\tPatch: &networking.EnvoyFilter_Patch{\r\n\t\t\t\t\t\tOperation: networking.EnvoyFilter_Patch_MERGE,\r\n\t\t\t\t\t\tValue:     util.BuildPatchStruct(tracingConfig),\r\n\t\t\t\t\t},\r\n\t\t\t\t},\r\n\t\t\t\t{\r\n\t\t\t\t\tApplyTo: networking.EnvoyFilter_HTTP_FILTER,\r\n\t\t\t\t\tMatch: &networking.EnvoyFilter_EnvoyConfigObjectMatch{\r\n\t\t\t\t\t\tContext: networking.EnvoyFilter_GATEWAY,\r\n\t\t\t\t\t\tObjectTypes: &networking.EnvoyFilter_EnvoyConfigObjectMatch_Listener{\r\n\t\t\t\t\t\t\tListener: &networking.EnvoyFilter_ListenerMatch{\r\n\t\t\t\t\t\t\t\tFilterChain: &networking.EnvoyFilter_ListenerMatch_FilterChainMatch{\r\n\t\t\t\t\t\t\t\t\tFilter: &networking.EnvoyFilter_ListenerMatch_FilterMatch{\r\n\t\t\t\t\t\t\t\t\t\tName: \"envoy.filters.network.http_connection_manager\",\r\n\t\t\t\t\t\t\t\t\t\tSubFilter: &networking.EnvoyFilter_ListenerMatch_SubFilterMatch{\r\n\t\t\t\t\t\t\t\t\t\t\tName: \"envoy.filters.http.router\",\r\n\t\t\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t},\r\n\t\t\t\t\tPatch: &networking.EnvoyFilter_Patch{\r\n\t\t\t\t\t\tOperation: networking.EnvoyFilter_Patch_MERGE,\r\n\t\t\t\t\t\tValue: util.BuildPatchStruct(`{\r\n\t\t\t\t\t\t\t\"name\":\"envoy.filters.http.router\",\r\n\t\t\t\t\t\t\t\"typed_config\":{\r\n\t\t\t\t\t\t\t\t\"@type\": \"type.googleapis.com/envoy.extensions.filters.http.router.v3.Router\",\r\n\t\t\t\t\t\t\t\t\"start_child_span\": true\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}`),\r\n\t\t\t\t\t},\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t},\r\n\t}\r\n\r\n\tconfigs = append(configs, config)\r\n\treturn configs, nil\r\n}\r\n```\r\n\r\n\r\n## 如何扩展全局配置\r\n\r\n### 1. HigressConfig 结构体添加对应的扩展配置\r\n\r\n```golang\r\ntype HigressConfig struct {\r\n\tTracing *Tracing `json:\"tracing,omitempty\"`\r\n\t// 在这里添加对应的数据结构来扩展配置\r\n}\r\n```\r\n\r\n### 2. 增加扩展配置默认值\r\n\r\n```golang\r\n// pkg/ingress/kube/configmap/config.go\r\nfunc NewDefaultHigressConfig() *HigressConfig {\r\n\thigressConfig := &HigressConfig{\r\n\t\tTracing: NewDefaultTracing(),\r\n\t\t// 在这里增加扩展配置默认值\r\n\t}\r\n\treturn higressConfig\r\n}\r\n```\r\n\r\n### 3. 实现 ItemController interface\r\n\r\n```golang\r\ntype ItemController interface {\r\n\tGetName() string\r\n\tAddOrUpdateHigressConfig(name util.ClusterNamespacedName, old *HigressConfig, new *HigressConfig) error\r\n\tValidHigressConfig(higressConfig *HigressConfig) error\r\n\tConstructEnvoyFilters() ([]*config.Config, error)\r\n\tRegisterItemEventHandler(eventHandler ItemEventHandler)\r\n}\r\n```\r\n\r\n### 4. 初始化扩展配置，同时添加到 ItemControllers\r\n\r\n```golang\r\nfunc NewConfigmapMgr(XDSUpdater model.XDSUpdater, namespace string, higressConfigController HigressConfigController, higressConfigLister listersv1.ConfigMapNamespaceLister) *ConfigmapMgr {\r\n\t// ...\r\n\ttracingController := NewTracingController(namespace)\r\n\tconfigmapMgr.AddItemControllers(tracingController)\r\n\t// ...\r\n\t// 在这里初始化扩展配置，同时添加到 ItemControllers\r\n\tconfigmapMgr.initEventHandlers()\r\n\r\n\treturn configmapMgr\r\n}\r\n```\r\n\r\n## 参与社区贡献\r\n\r\nHigress 开源贡献小组正在火热招募贡献者。早期参与开源更容易成为项目 Committer ，并有更多机会成为 Higress PMC(Project Management Committee) 的一员，参与主导 Higress 社区的前进方向。\r\n欢迎加入 Higress 社区群：\r\n\r\n\r\n![]( https://img.alicdn.com/imgextra/i1/O1CN0166Gkdt1cRTVjJ2skL_!!6000000003597-2-tps-720-405.png)", "content_rendered": "<h2>Higress 介绍</h2>\n<p><a href=\"https://github.com/alibaba/higress\" rel=\"nofollow\">Higress</a> 是基于阿里巴巴内部两年多的 Envoy Gateway 实践沉淀，以开源 Istio 与 Envoy 为核心构建的下一代云原生网关。Higress 实现了安全防护网关、流量网关、微服务网关三层网关合一，可以显著降低网关的部署和运维成本。</p>\n<p>官网地址： <a href=\"https://higress.cn\" rel=\"nofollow\">https://higress.cn</a></p>\n<p>GitHub 地址： <a href=\"https://github.com/alibaba/higress\" rel=\"nofollow\">https://github.com/alibaba/higress</a></p>\n<p>Higress 作为云原生网关的核心优势如下：</p>\n<h3>易用性</h3>\n<p>“云原生”已经不再是一个新鲜词，但企业对云原生技术的学习使用成本仍有许多顾虑，对云原生新标准的追赶又有很多焦虑；</p>\n<p>Higress 同时提供了本地安装/生产部署的 quickstart ，可以一键部署，并通过控制台操作快速上手；基于简单易用的控制台，Higress 可以封装 Ingress/Gateway API 的标准细节，根治技术追赶焦虑。</p>\n<h3>标准化</h3>\n<p>K8s 带来了云原生的路由标准 Ingress/Gateway API ，如同 POSIX 定义 Unix 可移植操作系统标准，历时 35 年经久不衰，云原生的路由标准的生命周期一定会远超过 K8s 本身；</p>\n<p>Higress 结合阿里内部实践以及阿里云产品沉淀，积累了基于 Ingress API 的丰富的路由策略扩展能力，同时还兼容大部分 Nginx Ingress 能力，这些能力后续也将在 Gateway API 上支持。</p>\n<h3>高集成</h3>\n<p>企业内有大量传统架构部署的服务，会成为向云原生架构演进的技术负担，要求云原生网关具备对接异构服务架构的能力；</p>\n<p>基于 Higress 提供的多种服务发现机制，网关路由不仅可以转发到 K8s 服务，也可以直接配置 IP 转发到到物理机上的服务；基于 Nacos/ZooKeeper 等注册中心对接，还可以轻松实现 Spring Cloud 和 Dubbo 微服务的路由，无论其是否部署在 K8s 内。</p>\n<h3>易扩展</h3>\n<p>基于扩展机制进行二次开发的能力，是云原生网关在不同业务场景下都能适配落地的关键；</p>\n<p>Higress 提供了灵活的插件扩展机制，目前插件市场已经推出多个官方插件，并支持用户通过控制台直接上传自己开发的插件，同时开源社区的插件市场生态也在不断建设中。</p>\n<h3>热更新</h3>\n<p>传统 Nginx 更新规则需要 reload 会导致链接抖动，导致流量损失，对实时通信、视频、IOT 无法容忍；</p>\n<p>对于路由规则，Wasm 插件逻辑更新，以及证书改动等等，Higress 全部支持热更新，不会造成任何连接抖动。</p>\n<h2>Higress 全局配置</h2>\n<p>下文将介绍 Higress 全局配置控制面实现机制，Higress 数据面基于 Envoy 是 C++ 语言开发，控制面则是基于 Go 语言开发。控制面的开发上手门槛还是很低的，欢迎有更多同学参与贡献。社区也有多个学习兴趣小组，欢迎加入学习： <a href=\"https://github.com/alibaba/higress/issues?q=is%3Aopen+is%3Aissue+label%3A%22learning+to+share%22\" rel=\"nofollow\">https://github.com/alibaba/higress/issues?q=is%3Aopen+is%3Aissue+label%3A%22learning+to+share%22</a></p>\n<p>Higress 有个全局配置 ConfigMap 对象 higress-config ，参考配置如下：</p>\n<pre><code class=\"language-yaml\">apiVersion: v1\ndata:\n  higress: |-\n    tracing:\n      enable: true\n      sampling: 100\n      timeout: 500\n      skywalking:\n       service: skywalking-oap-server.op-system.svc.cluster.local\n       port: 11800\n...\n...\nkind: ConfigMap\nmetadata:\n  name: higress-config\n  namespace: higress-system\n</code></pre>\n<p>具体配置说明请参考 <a href=\"https://higress.io/zh-cn/docs/user/configmap\" rel=\"nofollow\">Higress 全局配置说明文档</a>，\n本文介绍以 Tracing 为例，详细说明 Tracing 全局配置是如何转成 EnvoyFilter 和如何同时实现实时下发到 Higress Gateway 过程。</p>\n<p>本文涉及整体架构流程、初始化过程和启动、higress-config 变更和处理流程、通知 XDSUpdater 、构建 EnvoyFilter 和下发以及如何扩展全局配置等内容。</p>\n<h2>整体架构流程</h2>\n<h3>1. 整体架构</h3>\n<p><img alt=\"img.png\" class=\"embedded_image\" loading=\"lazy\" referrerpolicy=\"no-referrer\" rel=\"noreferrer\" src=\"https://higress.io/zh-cn/assets/images/configmap1-f2447fa1bd9826e78e29bcdf1f38a4ca.png\"/></p>\n<h3>2. 核心组件</h3>\n<ul>\n<li>IngressConfig</li>\n</ul>\n<p>IngressConfig 是 Higress 一个核心结构体, 负责监控 Ingress ，McpBridge, Http2Rpc, WasmPlugin 等 k8s 资源， 同时集成 ConfigStore Interface ，通过 List 接口下发 VirtualService, DestinationRule, EnvoyFilter, ServiceEntry, WasmPlugin 等 CR 资源。</p>\n<ul>\n<li>ConfigmapMgr</li>\n</ul>\n<p>ConfigmapMgr 结构体负责整个核心流程，包括通过 Informer List/Watch 机制监控 higress-config 的变更，同时遍历 ItemControllers 下发变更通知，提供构建 EnvoyFilter 列表等功能。</p>\n<ul>\n<li>TracingController</li>\n</ul>\n<p>TracingController 结构体负责具体的 Tracing 数据校验，构建 Tracing EnvoyFilter, 以及通过 ItemEventHandler 下发变更通知等。</p>\n<ul>\n<li>HigressConfig</li>\n</ul>\n<p>HigressConfig 是 higress-config Configmap 所对应数据的结构体。</p>\n<h3>3. 核心流程</h3>\n<ul>\n<li>用 Informer List/Watch 机制监控 higress-config 变更，校验变更，同时保存变更后数据。</li>\n<li>用变更数据构建 EnvoyFilter 。</li>\n<li>通知 XDSUpdater ，EnvoyFilter 有变更，重新拉取新的 EnvoyFilter 列表。</li>\n</ul>\n<h2>初始化过程</h2>\n<h3>1. 初始化入口</h3>\n<p>初始化过程入口在 NewIngressConfig ， 初始化 IngressConfig 时同时构建 HigressConfigController 和 ConfigmapMgr 。</p>\n<pre><code class=\"language-golang\">// pkg/ingress/config/ingress_config.go\nfunc NewIngressConfig(localKubeClient kube.Client, XDSUpdater model.XDSUpdater, namespace, clusterId string) *IngressConfig {\n\t// ...\n\t\n\t// 构建 controller 和 configmapMgr\n\thigressConfigController := configmap.NewController(localKubeClient, clusterId, namespace)\n\tconfig.configmapMgr = configmap.NewConfigmapMgr(XDSUpdater, namespace, higressConfigController, higressConfigController.Lister())\n\n\treturn config\n}\n</code></pre>\n<h3>2. HigressConfigController 初始化</h3>\n<p>通过 Higress 提供 NewCommonController 初始化 HigressConfigController 用于监听 higress-system 命名空间下 Configmap 的变化。</p>\n<pre><code class=\"language-golang\">// pkg/ingress/kube/configmap/controller.go\ntype HigressConfigController controller.Controller[listersv1.ConfigMapNamespaceLister]\n\nfunc NewController(client kubeclient.Client, clusterId string, namespace string) HigressConfigController {\n\tinformer := client.KubeInformer().Core().V1().ConfigMaps().Informer()\n\treturn controller.NewCommonController(\"higressConfig\", client.KubeInformer().Core().V1().ConfigMaps().Lister().ConfigMaps(namespace),\n\t\tinformer, GetConfigmap, clusterId)\n}\n\nfunc GetConfigmap(lister listersv1.ConfigMapNamespaceLister, namespacedName types.NamespacedName) (controllers.Object, error) {\n\treturn lister.Get(namespacedName.Name)\n}\n</code></pre>\n<h3>3. ConfigmapMgr 初始化</h3>\n<p>ConfigmapMgr 初始化具体步骤如下：</p>\n<ul>\n<li>构建 ConfigmapMgr</li>\n<li>设置 HigressConfigController configmap 新增或者更新回调函数为 configmapMgr.AddOrUpdateHigressConfig</li>\n<li>设置 HigressConfig 结构体默认值</li>\n<li>初始化 TracingController</li>\n<li>把 tracingController 添加到 configmapMgr itemControllers 数组里</li>\n<li>初始化 ItemEventHandler ， 同时遍历 itemControllers ，设置 ItemEventHandler</li>\n</ul>\n<pre><code class=\"language-golang\">// pkg/ingress/kube/configmap/controller.go\nfunc NewConfigmapMgr(XDSUpdater model.XDSUpdater, namespace string, higressConfigController HigressConfigController, higressConfigLister listersv1.ConfigMapNamespaceLister) *ConfigmapMgr {\n    //  构建 ConfigmapMgr\n\tconfigmapMgr := &amp;ConfigmapMgr{\n\t\tXDSUpdater:              XDSUpdater,\n\t\tNamespace:               namespace,\n\t\tHigressConfigController: higressConfigController,\n\t\tHigressConfigLister:     higressConfigLister,\n\t\thigressConfig:           atomic.Value{},\n\t}\n\t// 设置 HigressConfigController configmap 新增或者更新回调函数 configmapMgr.AddOrUpdateHigressConfig\n\tconfigmapMgr.HigressConfigController.AddEventHandler(configmapMgr.AddOrUpdateHigressConfig)\n\t// 设置 HigressConfig 结构体默认值\n\tconfigmapMgr.SetHigressConfig(NewDefaultHigressConfig())\n\n\t// 初始化 TracingController\n\ttracingController := NewTracingController(namespace)\n\t// 把 tracingController 添加到 configmapMgr itemControllers 里\n\tconfigmapMgr.AddItemControllers(tracingController)\n\t// 初始化 itemEventHandler ， 同时遍历 itemControllers ，设置 itemEventHandler\n\tconfigmapMgr.initEventHandlers()\n\n\t// 返回 configmapMgr\n\treturn configmapMgr\n}\n</code></pre>\n<h2>启动</h2>\n<p>在 IngressConfig 添加 HigressConfigController Run() 和 HasSynced() 控制流程。</p>\n<pre><code class=\"language-golang\">// pkg/ingress/config/ingress_config.go\nfunc (m *IngressConfig) Run(stop &lt;-chan struct{}) {\n\t// ...\n\t// 启动 HigressConfigController\n\tgo m.configmapMgr.HigressConfigController.Run(stop)\n}\n\nfunc (m *IngressConfig) HasSynced() bool {\n\t// ....\n\tif !m.configmapMgr.HigressConfigController.HasSynced() {\n\t\treturn false\n\t}\n}\n</code></pre>\n<h2>higress-config 变更和处理流程</h2>\n<h3>1. configmapMgr 变更处理</h3>\n<p>ConfigmapMgr 通过收到 HigressConfigController 通知来处理变更请求。</p>\n<p>具体变更流程如下：</p>\n<ul>\n<li>判断是否 higress-system 命名空间下 name 为 higress-config Configmap 发生了变化，如果不是就返回。</li>\n<li>获取 higress-config 内容。</li>\n<li>遍历 ItemControllers, 校验 higress-config 配置是否合法，如果有一个返回不合法，就返回。</li>\n<li>和上次保存在本地 higressConfig 比对, 检查这次数据是否有变化，如果没有变化就返回。</li>\n<li>如果数据有变化，就遍历 ItemControllers 通知每个 itemController 数据有变化，同时保存这次变化到本地 higressConfig 。</li>\n</ul>\n<pre><code class=\"language-golang\">// pkg/ingress/kube/configmap/controller.go\nfunc (c *ConfigmapMgr) AddOrUpdateHigressConfig(name util.ClusterNamespacedName) {\n\t// 只监听 higress-system 命名空间下 name 为 higress-config Configmap 的变化\n\tif name.Namespace != c.Namespace || name.Name != HigressConfigMapName {\n\t\treturn\n\t}\n    // ...\n\t// 获取 higress-config 内容\n\thigressConfigmap, err := c.HigressConfigLister.Get(HigressConfigMapName)\n\t\n\t// 通过 yaml.Unmarshal 转成 HigressConfig\n\tnewHigressConfig := NewDefaultHigressConfig()\n\tif err = yaml.Unmarshal([]byte(higressConfigmap.Data[HigressConfigMapKey]), newHigressConfig); err != nil {\n\t\tIngressLog.Errorf(\"data:%s,  convert to higress config error, error: %+v\", higressConfigmap.Data[HigressConfigMapKey], err)\n\t\treturn\n\t}\n\n\t// ...\n\t// 遍历 ItemControllers, 校验配置是否合法\n\tfor _, itemController := range c.ItemControllers {\n\t\tif itemErr := itemController.ValidHigressConfig(newHigressConfig); itemErr != nil {\n\t\t\tIngressLog.Errorf(\"configmap %s controller valid higress config error, error: %+v\", itemController.GetName(), itemErr)\n\t\t\treturn\n\t\t}\n\t}\n\n\t// 和上次比对这次数据是否有变更\n\toldHigressConfig := c.GetHigressConfig()\n\tresult, _ := c.CompareHigressConfig(oldHigressConfig, newHigressConfig)\n    // ...\n\t// 如果数据有变更，就遍历 ItemControllers 通知每个 itemController 数据有变更，同时保存这次变更到本地。\n\tif result == ResultReplace || result == ResultDelete {\n\t\tfor _, itemController := range c.ItemControllers {\n\t\t\tIngressLog.Infof(\"configmap %s controller AddOrUpdateHigressConfig\", itemController.GetName())\n\t\t\tif itemErr := itemController.AddOrUpdateHigressConfig(name, oldHigressConfig, newHigressConfig); itemErr != nil {\n\t\t\t\tIngressLog.Errorf(\"configmap %s controller AddOrUpdateHigressConfig error, error: %+v\", itemController.GetName(), itemErr)\n\t\t\t}\n\t\t}\n\t\t// 保存这次变更\n\t\tc.SetHigressConfig(newHigressConfig)\n\t}\n}\n</code></pre>\n<h3>2. TracingController 变更处理</h3>\n<p>TracingController 变更处理就比较简单：</p>\n<ul>\n<li>检查 Tracing 这部分数据是否有变更。</li>\n<li>如果有变更，DeepCopy 一份 Tracing 数据保存到本地，同时通过 eventHandler 下发变更通知。</li>\n</ul>\n<pre><code class=\"language-golang\">// pkg/ingress/kube/configmap/tracing.go\nfunc (t *TracingController) AddOrUpdateHigressConfig(name util.ClusterNamespacedName, old *HigressConfig, new *HigressConfig) error {\n\t// ...\n\t// 检查 Tracing 部分数据是否有变更\n\tresult, _ := compareTracing(old.Tracing, new.Tracing)\n\n\t// 如果有变更，DeepCopy 一份 Tracing 数据保存到本地，同时通过 eventHandler 下发变更通知\n\tswitch result {\n\tcase ResultReplace:\n\t\tif newTracing, err := deepCopyTracing(new.Tracing); err != nil {\n\t\t\tIngressLog.Infof(\"tracing deepcopy error:%v\", err)\n\t\t} else {\n\t\t\tt.SetTracing(newTracing)\n\t\t\tIngressLog.Infof(\"AddOrUpdate Higress config tracing\")\n\t\t\tt.eventHandler(higressTracingEnvoyFilterName)\n\t\t\tIngressLog.Infof(\"send event with filter name:%s\", higressTracingEnvoyFilterName)\n\t\t}\n\tcase ResultDelete:\n\t\tt.SetTracing(NewDefaultTracing())\n\t\tIngressLog.Infof(\"Delete Higress config tracing\")\n\t\tt.eventHandler(higressTracingEnvoyFilterName)\n\t\tIngressLog.Infof(\"send event with filter name:%s\", higressTracingEnvoyFilterName)\n\t}\n\n\treturn nil\n}\n</code></pre>\n<h2>通知 XDSUpdater</h2>\n<p>在 ConfigmapMgr 初始化时候调用 configmapMgr.initEventHandlers()， 这个 func 会创建 ItemEventHandler, 同时遍历 ItemControllers 设置 ItemEventHandler 。</p>\n<pre><code class=\"language-golang\">// pkg/ingress/kube/configmap/config.go\ntype ItemEventHandler = func(name string)\n\n// pkg/ingress/kube/configmap/controller.go\nfunc (c *ConfigmapMgr) initEventHandlers() error {\n    itemEventHandler := func(name string) {\n    c.XDSUpdater.ConfigUpdate(&amp;model.PushRequest{\n        Full: true,\n        ConfigsUpdated: map[model.ConfigKey]struct{}{{\n            Kind:      gvk.EnvoyFilter,\n            Name:      name,\n            Namespace: c.Namespace,\n        }: {}},\n        Reason: []model.TriggerReason{ModelUpdatedReason},\n        })\n    }\n    \n    for _, itemController := range c.ItemControllers {\n\t\titemController.RegisterItemEventHandler(itemEventHandler)\n    }\n    \n    return nil\n}\n</code></pre>\n<p>这里 XDSUpdater 是从 IngressConfig 初始化传入，XDSUpdater.ConfigUpdate() 用于更新通知下发。</p>\n<p>进一步跟踪可以发现在 Higress controller server 启动时执行 s.initXdsServer 函数创建 s.xdsServer ，具体逻辑不在本文讨论范围, 有兴趣可以进一步阅读源码。</p>\n<pre><code class=\"language-golang\">// pkg/bootstrap/server.go\nfunc NewServer(args *ServerArgs) (*Server, error) {\n\t// ...\n\ts := &amp;Server{\n\t\tServerArgs:      args,\n\t\thttpMux:         http.NewServeMux(),\n\t\tenvironment:     e,\n\t\treadinessProbes: make(map[string]readinessProbe),\n\t\tserver:          server.New(),\n\t}\n\ts.environment.Watcher = mesh.NewFixedWatcher(&amp;v1alpha1.MeshConfig{})\n\ts.environment.Init()\n\tinitFuncList := []func() error{\n\t\ts.initKubeClient,\n\t\ts.initXdsServer,\n\t\ts.initHttpServer,\n\t\ts.initConfigController,\n\t\ts.initRegistryEventHandlers,\n\t\ts.initAuthenticators,\n\t}\n\n\tfor _, f := range initFuncList {\n\t\tif err := f(); err != nil {\n\t\t\treturn nil, err\n\t\t}\n\t}\n\n\t// ...\n\treturn s, nil\n}\n\n// pkg/bootstrap/server.go\nfunc (s *Server) initXdsServer() error {\n    log.Info(\"init xds server\")\n    s.xdsServer = xds.NewDiscoveryServer(s.environment, nil, PodName, PodNamespace, s.RegistryOptions.KubeOptions.ClusterAliases)\n    // ...\n    return s.initGrpcServer()\n}\n</code></pre>\n<h2>构建和下发 EnvoyFilters</h2>\n<h3>1. IngressConfig List 下发 EnvoyFilters 列表</h3>\n<p>IngressConfig List 用于 VirtualService, DestinationRule, EnvoyFilter, ServiceEntry, WasmPlugin 等 CR 资源下发， 这里主要关注 EnvoyFilter CR 资源下发。</p>\n<pre><code class=\"language-golang\">// pkg/ingress/config/ingress_config.go\nfunc (m *IngressConfig) List(typ config.GroupVersionKind, namespace string) ([]config.Config, error) {\n\tif typ != gvk.Gateway &amp;&amp;\n\t\ttyp != gvk.VirtualService &amp;&amp;\n\t\ttyp != gvk.DestinationRule &amp;&amp;\n\t\ttyp != gvk.EnvoyFilter &amp;&amp;\n\t\ttyp != gvk.ServiceEntry &amp;&amp;\n\t\ttyp != gvk.WasmPlugin {\n\t\treturn nil, common.ErrUnsupportedOp\n\t}\n\t// ...\n\tif typ == gvk.EnvoyFilter {\n\t\tm.mutex.RLock()\n\t\tdefer m.mutex.RUnlock()\n\t\tvar envoyFilters []config.Config\n\t\t\n\t\t// 调用 ConfigmapMgr ConstructEnvoyFilters 获取需要下发 EnvoyFilter 列表\n\t\tconfigmapEnvoyFilters, err := m.configmapMgr.ConstructEnvoyFilters()\n\t\tif err != nil {\n\t\t\tIngressLog.Errorf(\"Construct configmap EnvoyFilters error %v\", err)\n\t\t} else {\n\t\t\tfor _, envoyFilter := range configmapEnvoyFilters {\n\t\t\t\tenvoyFilters = append(envoyFilters, *envoyFilter)\n\t\t\t}\n\t\t\tIngressLog.Infof(\"Append %d configmap EnvoyFilters\", len(configmapEnvoyFilters))\n\t\t}\n\t\tif len(envoyFilters) == 0 {\n\t\t\tIngressLog.Infof(\"resource type %s, configs number %d\", typ, len(m.cachedEnvoyFilters))\n\t\t\treturn m.cachedEnvoyFilters, nil\n\t\t}\n\t\t// 需要下发 configmap EnvoyFilter 列表 和 m.cachedEnvoyFilters 列表聚合一下下发\n\t\tenvoyFilters = append(envoyFilters, m.cachedEnvoyFilters...)\n\t\tIngressLog.Infof(\"resource type %s, configs number %d\", typ, len(envoyFilters))\n\t\treturn envoyFilters, nil\n\t}\n\t\n}\t\n</code></pre>\n<p>调用 ConfigmapMgr ConstructEnvoyFilters 获取需要下发 EnvoyFilter 列表， 同时和 m.cachedEnvoyFilters 列表聚合一下再下发。</p>\n<p>这里 m.cachedEnvoyFilters 是在构建 VirtualService 时生成，有兴趣可以进一步阅读 IngressConfig 源码。</p>\n<h3>2. ConfigmapMgr 构建 EnvoyFilter 列表</h3>\n<p>这里比较简单，遍历一下 ItemControllers ，聚合每个 itemController 返回的 EnvoyFilters.</p>\n<pre><code class=\"language-golang\">// /pkg/ingress/kube/configmap/controller.go\nfunc (c *ConfigmapMgr) ConstructEnvoyFilters() ([]*config.Config, error) {\n\tconfigs := make([]*config.Config, 0)\n\tfor _, itemController := range c.ItemControllers {\n\t\tIngressLog.Infof(\"controller %s ConstructEnvoyFilters\", itemController.GetName())\n\t\tif itemConfigs, err := itemController.ConstructEnvoyFilters(); err != nil {\n\t\t\tIngressLog.Errorf(\"controller %s ConstructEnvoyFilters error, error: %+v\", itemController.GetName(), err)\n\t\t} else {\n\t\t\tconfigs = append(configs, itemConfigs...)\n\t\t}\n\t}\n\treturn configs, nil\n}\n</code></pre>\n<h3>3. TracingController 构建 EnvoyFilters</h3>\n<p>这里就比较简单，根据保存的 Tracing 数据构建对应的 EnvoyFilter</p>\n<pre><code class=\"language-golang\">// pkg/ingress/kube/configmap/tracing.go\nfunc (t *TracingController) ConstructEnvoyFilters() ([]*config.Config, error) {\n\t// ...\n\ttracingConfig := t.constructTracingTracer(tracing, namespace)\n\tif len(tracingConfig) == 0 {\n\t\treturn configs, nil\n\t}\n\n\tconfig := &amp;config.Config{\n\t\tMeta: config.Meta{\n\t\t\tGroupVersionKind: gvk.EnvoyFilter,\n\t\t\tName:             higressTracingEnvoyFilterName,\n\t\t\tNamespace:        namespace,\n\t\t},\n\t\tSpec: &amp;networking.EnvoyFilter{\n\t\t\tConfigPatches: []*networking.EnvoyFilter_EnvoyConfigObjectPatch{\n\t\t\t\t{\n\t\t\t\t\tApplyTo: networking.EnvoyFilter_NETWORK_FILTER,\n\t\t\t\t\tMatch: &amp;networking.EnvoyFilter_EnvoyConfigObjectMatch{\n\t\t\t\t\t\tContext: networking.EnvoyFilter_GATEWAY,\n\t\t\t\t\t\tObjectTypes: &amp;networking.EnvoyFilter_EnvoyConfigObjectMatch_Listener{\n\t\t\t\t\t\t\tListener: &amp;networking.EnvoyFilter_ListenerMatch{\n\t\t\t\t\t\t\t\tFilterChain: &amp;networking.EnvoyFilter_ListenerMatch_FilterChainMatch{\n\t\t\t\t\t\t\t\t\tFilter: &amp;networking.EnvoyFilter_ListenerMatch_FilterMatch{\n\t\t\t\t\t\t\t\t\t\tName: \"envoy.filters.network.http_connection_manager\",\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\tPatch: &amp;networking.EnvoyFilter_Patch{\n\t\t\t\t\t\tOperation: networking.EnvoyFilter_Patch_MERGE,\n\t\t\t\t\t\tValue:     util.BuildPatchStruct(tracingConfig),\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tApplyTo: networking.EnvoyFilter_HTTP_FILTER,\n\t\t\t\t\tMatch: &amp;networking.EnvoyFilter_EnvoyConfigObjectMatch{\n\t\t\t\t\t\tContext: networking.EnvoyFilter_GATEWAY,\n\t\t\t\t\t\tObjectTypes: &amp;networking.EnvoyFilter_EnvoyConfigObjectMatch_Listener{\n\t\t\t\t\t\t\tListener: &amp;networking.EnvoyFilter_ListenerMatch{\n\t\t\t\t\t\t\t\tFilterChain: &amp;networking.EnvoyFilter_ListenerMatch_FilterChainMatch{\n\t\t\t\t\t\t\t\t\tFilter: &amp;networking.EnvoyFilter_ListenerMatch_FilterMatch{\n\t\t\t\t\t\t\t\t\t\tName: \"envoy.filters.network.http_connection_manager\",\n\t\t\t\t\t\t\t\t\t\tSubFilter: &amp;networking.EnvoyFilter_ListenerMatch_SubFilterMatch{\n\t\t\t\t\t\t\t\t\t\t\tName: \"envoy.filters.http.router\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\tPatch: &amp;networking.EnvoyFilter_Patch{\n\t\t\t\t\t\tOperation: networking.EnvoyFilter_Patch_MERGE,\n\t\t\t\t\t\tValue: util.BuildPatchStruct(`{\n\t\t\t\t\t\t\t\"name\":\"envoy.filters.http.router\",\n\t\t\t\t\t\t\t\"typed_config\":{\n\t\t\t\t\t\t\t\t\"@type\": \"type.googleapis.com/envoy.extensions.filters.http.router.v3.Router\",\n\t\t\t\t\t\t\t\t\"start_child_span\": true\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}`),\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t}\n\n\tconfigs = append(configs, config)\n\treturn configs, nil\n}\n</code></pre>\n<h2>如何扩展全局配置</h2>\n<h3>1. HigressConfig 结构体添加对应的扩展配置</h3>\n<pre><code class=\"language-golang\">type HigressConfig struct {\n\tTracing *Tracing `json:\"tracing,omitempty\"`\n\t// 在这里添加对应的数据结构来扩展配置\n}\n</code></pre>\n<h3>2. 增加扩展配置默认值</h3>\n<pre><code class=\"language-golang\">// pkg/ingress/kube/configmap/config.go\nfunc NewDefaultHigressConfig() *HigressConfig {\n\thigressConfig := &amp;HigressConfig{\n\t\tTracing: NewDefaultTracing(),\n\t\t// 在这里增加扩展配置默认值\n\t}\n\treturn higressConfig\n}\n</code></pre>\n<h3>3. 实现 ItemController interface</h3>\n<pre><code class=\"language-golang\">type ItemController interface {\n\tGetName() string\n\tAddOrUpdateHigressConfig(name util.ClusterNamespacedName, old *HigressConfig, new *HigressConfig) error\n\tValidHigressConfig(higressConfig *HigressConfig) error\n\tConstructEnvoyFilters() ([]*config.Config, error)\n\tRegisterItemEventHandler(eventHandler ItemEventHandler)\n}\n</code></pre>\n<h3>4. 初始化扩展配置，同时添加到 ItemControllers</h3>\n<pre><code class=\"language-golang\">func NewConfigmapMgr(XDSUpdater model.XDSUpdater, namespace string, higressConfigController HigressConfigController, higressConfigLister listersv1.ConfigMapNamespaceLister) *ConfigmapMgr {\n\t// ...\n\ttracingController := NewTracingController(namespace)\n\tconfigmapMgr.AddItemControllers(tracingController)\n\t// ...\n\t// 在这里初始化扩展配置，同时添加到 ItemControllers\n\tconfigmapMgr.initEventHandlers()\n\n\treturn configmapMgr\n}\n</code></pre>\n<h2>参与社区贡献</h2>\n<p>Higress 开源贡献小组正在火热招募贡献者。早期参与开源更容易成为项目 Committer ，并有更多机会成为 Higress PMC(Project Management Committee) 的一员，参与主导 Higress 社区的前进方向。\n欢迎加入 Higress 社区群：</p>\n<p><img alt=\"\" class=\"embedded_image\" loading=\"lazy\" referrerpolicy=\"no-referrer\" rel=\"noreferrer\" src=\"https://img.alicdn.com/imgextra/i1/O1CN0166Gkdt1cRTVjJ2skL_%21%216000000003597-2-tps-720-405.png\"/></p>\n", "last_modified": 1690370849, "replies": 111, "id": 959994}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/6e27/13a6/557_large.png?m=1608969785", "name": "life", "avatar_normal": "https://cdn.v2ex.com/navatar/6e27/13a6/557_normal.png?m=1608969785", "title": "生活", "url": "https://www.v2ex.com/go/life", "topics": 4667, "footer": "", "header": "生活中的技术讨论", "title_alternative": "Life", "avatar_mini": "https://cdn.v2ex.com/navatar/6e27/13a6/557_mini.png?m=1608969785", "stars": 1165, "aliases": [], "root": false, "id": 557, "parent_node_name": ""}, "member": {"id": 405279, "username": "blackdd", "url": "https://www.v2ex.com/u/blackdd", "website": null, "twitter": null, "psn": null, "github": null, "btc": null, "location": null, "tagline": null, "bio": null, "avatar_mini": "https://cdn.v2ex.com/avatar/0bfc/7e5d/405279_mini.png?m=1689908671", "avatar_normal": "https://cdn.v2ex.com/avatar/0bfc/7e5d/405279_normal.png?m=1689908671", "avatar_large": "https://cdn.v2ex.com/avatar/0bfc/7e5d/405279_large.png?m=1689908671", "avatar_xlarge": "https://cdn.v2ex.com/avatar/0bfc/7e5d/405279_xlarge.png?m=1689908671", "avatar_xxlarge": "https://cdn.v2ex.com/avatar/0bfc/7e5d/405279_xlarge.png?m=1689908671", "avatar_xxxlarge": "https://cdn.v2ex.com/avatar/0bfc/7e5d/405279_xlarge.png?m=1689908671", "created": 1556022446, "last_modified": 1689908671}, "last_reply_by": "Tyuans", "last_touched": 1690445192, "title": "成年人每天 5-6 个小时的睡眠时间足够么", "url": "https://www.v2ex.com/t/960074", "created": 1690420173, "deleted": 0, "content": "最近家里的猫要生了，不得不跨城上班，又因为限行,每天早上很早就要出门，每天就睡了 5-6 个小时，持续一周下实在顶不住了", "content_rendered": "<p>最近家里的猫要生了，不得不跨城上班，又因为限行,每天早上很早就要出门，每天就睡了 5-6 个小时，持续一周下实在顶不住了</p>\n", "last_modified": 1690420173, "replies": 110, "id": 960074}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/6e27/13a6/557_large.png?m=1608969785", "name": "life", "avatar_normal": "https://cdn.v2ex.com/navatar/6e27/13a6/557_normal.png?m=1608969785", "title": "生活", "url": "https://www.v2ex.com/go/life", "topics": 4667, "footer": "", "header": "生活中的技术讨论", "title_alternative": "Life", "avatar_mini": "https://cdn.v2ex.com/navatar/6e27/13a6/557_mini.png?m=1608969785", "stars": 1165, "aliases": [], "root": false, "id": 557, "parent_node_name": ""}, "member": {"id": 520914, "username": "showonder", "url": "https://www.v2ex.com/u/showonder", "website": null, "twitter": null, "psn": null, "github": null, "btc": null, "location": null, "tagline": null, "bio": null, "avatar_mini": "https://cdn.v2ex.com/gravatar/9757690bf7334d7c0a2a2e6c49d4fc0a?s=24&d=retro", "avatar_normal": "https://cdn.v2ex.com/gravatar/9757690bf7334d7c0a2a2e6c49d4fc0a?s=48&d=retro", "avatar_large": "https://cdn.v2ex.com/gravatar/9757690bf7334d7c0a2a2e6c49d4fc0a?s=73&d=retro", "created": 1606466860, "last_modified": 1686022884}, "last_reply_by": "vincentkwok", "last_touched": 1690443893, "title": "求助！有人知道怎么向境外银行一次性汇款 50 万美金的渠道吗？", "url": "https://www.v2ex.com/t/960011", "created": 1690376948, "deleted": 0, "content": "最近在办 A 国永居（不注销国籍），有个前提是需要一次性汇一笔 50 万美元到自己名下在 A 国开立的银行账户，这笔钱必须是从 A 国以外的地区直接汇入，直接从咱们国家汇出有外汇管制，但我只有国内资产，其他国家的海外资产很少，也没有海外信任的人可以帮忙。从国内出金汇入 A 国账户有没有风险和成本比较低的渠道可以实现？", "content_rendered": "最近在办 A 国永居（不注销国籍），有个前提是需要一次性汇一笔 50 万美元到自己名下在 A 国开立的银行账户，这笔钱必须是从 A 国以外的地区直接汇入，直接从咱们国家汇出有外汇管制，但我只有国内资产，其他国家的海外资产很少，也没有海外信任的人可以帮忙。从国内出金汇入 A 国账户有没有风险和成本比较低的渠道可以实现？", "last_modified": 1690379297, "replies": 109, "id": 960011}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/94f6/d7e0/300_large.png?m=1689070442", "name": "programmer", "avatar_normal": "https://cdn.v2ex.com/navatar/94f6/d7e0/300_normal.png?m=1689070442", "title": "程序员", "url": "https://www.v2ex.com/go/programmer", "topics": 57609, "footer": "", "header": "While code monkeys are not eating bananas, they're coding.", "title_alternative": "Programmer", "avatar_mini": "https://cdn.v2ex.com/navatar/94f6/d7e0/300_mini.png?m=1689070442", "stars": 8501, "aliases": [], "root": false, "id": 300, "parent_node_name": "computer"}, "member": {"id": 637801, "username": "zetaochen", "url": "https://www.v2ex.com/u/zetaochen", "website": null, "twitter": null, "psn": null, "github": null, "btc": null, "location": null, "tagline": null, "bio": null, "avatar_mini": "https://cdn.v2ex.com/gravatar/32611d66bd52705bf30036124232f06a?s=24&d=retro", "avatar_normal": "https://cdn.v2ex.com/gravatar/32611d66bd52705bf30036124232f06a?s=48&d=retro", "avatar_large": "https://cdn.v2ex.com/gravatar/32611d66bd52705bf30036124232f06a?s=73&d=retro", "created": 1688965488, "last_modified": 1690378087}, "last_reply_by": "48odaerina", "last_touched": 1690444652, "title": "求推荐个实用的密码管理器", "url": "https://www.v2ex.com/t/960015", "created": 1690378098, "deleted": 0, "content": "好用 , 安全\r\n能支持多平台, 像有谷歌的插件,安卓,mac\r\n是免费的就最好啦", "content_rendered": "好用 , 安全<br />能支持多平台, 像有谷歌的插件,安卓,mac<br />是免费的就最好啦", "last_modified": 1690378098, "replies": 105, "id": 960015}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/8d31/7bdc/747_large.png?m=1523201604", "name": "deals", "avatar_normal": "https://cdn.v2ex.com/navatar/8d31/7bdc/747_normal.png?m=1523201604", "title": "优惠信息", "url": "https://www.v2ex.com/go/deals", "topics": 2181, "footer": "", "header": "这里分享和发布来自互联网上的最新优惠信息", "title_alternative": "Deals", "avatar_mini": "https://cdn.v2ex.com/navatar/8d31/7bdc/747_mini.png?m=1523201604", "stars": 3172, "aliases": [], "root": false, "id": 747, "parent_node_name": "life"}, "member": {"id": 23618, "username": "liqinliqin", "url": "https://www.v2ex.com/u/liqinliqin", "website": "www.doit.am", "twitter": "", "psn": "", "github": "smartarduino", "btc": "", "location": "深圳", "tagline": "www.doit.am", "bio": "机器人、物联网", "avatar_mini": "https://cdn.v2ex.com/avatar/80d4/c0e3/23618_mini.png?m=1650245704", "avatar_normal": "https://cdn.v2ex.com/avatar/80d4/c0e3/23618_normal.png?m=1650245704", "avatar_large": "https://cdn.v2ex.com/avatar/80d4/c0e3/23618_large.png?m=1650245704", "created": 1342575715, "last_modified": 1650245704}, "last_reply_by": "liqinliqin", "last_touched": 1690444485, "title": "9.9 元， WIFI+BLE,复古钨丝灯，摔不烂", "url": "https://www.v2ex.com/t/960099", "created": 1690423569, "deleted": 0, "content": "9.9 元，WIFI+BLE,复古钨丝灯，摔不烂\r\nhttps://detail.1688.com/offer/674726904804.html", "content_rendered": "9.9 元，WIFI+BLE,复古钨丝灯，摔不烂<br /><a target=\"_blank\" href=\"https://detail.1688.com/offer/674726904804.html\" rel=\"nofollow noopener\">https://detail.1688.com/offer/674726904804.html</a>", "last_modified": 1690423569, "replies": 96, "id": 960099}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/94f6/d7e0/300_large.png?m=1689070442", "name": "programmer", "avatar_normal": "https://cdn.v2ex.com/navatar/94f6/d7e0/300_normal.png?m=1689070442", "title": "程序员", "url": "https://www.v2ex.com/go/programmer", "topics": 57609, "footer": "", "header": "While code monkeys are not eating bananas, they're coding.", "title_alternative": "Programmer", "avatar_mini": "https://cdn.v2ex.com/navatar/94f6/d7e0/300_mini.png?m=1689070442", "stars": 8501, "aliases": [], "root": false, "id": 300, "parent_node_name": "computer"}, "member": {"id": 555634, "username": "itechnology", "url": "https://www.v2ex.com/u/itechnology", "website": null, "twitter": null, "psn": null, "github": null, "btc": null, "location": null, "tagline": null, "bio": null, "avatar_mini": "https://cdn.v2ex.com/avatar/ceca/7efb/555634_mini.png?m=1667268013", "avatar_normal": "https://cdn.v2ex.com/avatar/ceca/7efb/555634_normal.png?m=1667268013", "avatar_large": "https://cdn.v2ex.com/avatar/ceca/7efb/555634_large.png?m=1667268013", "created": 1631237690, "last_modified": 1667268013}, "last_reply_by": "pkwenda", "last_touched": 1690444601, "title": "真是绝了， github 上 YunaiV/ruoyi-vue-pro 项目打着开源的旗号收费", "url": "https://www.v2ex.com/t/960003", "created": 1690373602, "deleted": 0, "content": "今天无意中在 github 上发现了这个项目，点开发现 stars 挺多的，在 gitee 上 stars 更是惊人，有 73.4K 之多，想着 stars 这么多，项目应该不错，就 clone 到本地看下，准备看文档启动的时候问题来了，访问文档地址竟然要登录，这都没啥，你点击快速启动以及功能列表，会有个弹窗，要求你先 star 才能看。“后端手册”手册就更离谱了，要求你微信扫码加入星球，而加入星球需要支付 199 元人民币，也就是说，你要看到完整的文档，需要 star+支付 199 元人民币……\r\n\r\n他项目的 README.md 写着“芋道，以开发者为中心，打造中国第一流的快速开发平台，全部开源，个人与企业可 100% 免费使用”，代码可以免费使用，文档要收费，没毛病[手动狗头]", "content_rendered": "<p>今天无意中在 github 上发现了这个项目，点开发现 stars 挺多的，在 gitee 上 stars 更是惊人，有 73.4K 之多，想着 stars 这么多，项目应该不错，就 clone 到本地看下，准备看文档启动的时候问题来了，访问文档地址竟然要登录，这都没啥，你点击快速启动以及功能列表，会有个弹窗，要求你先 star 才能看。“后端手册”手册就更离谱了，要求你微信扫码加入星球，而加入星球需要支付 199 元人民币，也就是说，你要看到完整的文档，需要 star+支付 199 元人民币……</p>\n<p>他项目的 <a href=\"http://README.md\" rel=\"nofollow\">README.md</a> 写着“芋道，以开发者为中心，打造中国第一流的快速开发平台，全部开源，个人与企业可 100% 免费使用”，代码可以免费使用，文档要收费，没毛病[手动狗头]</p>\n", "last_modified": 1690374189, "replies": 86, "id": 960003}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/c20a/d4d7/12_large.png?m=1650095340", "name": "qna", "avatar_normal": "https://cdn.v2ex.com/navatar/c20a/d4d7/12_normal.png?m=1650095340", "title": "问与答", "url": "https://www.v2ex.com/go/qna", "topics": 207785, "footer": "", "header": "一个更好的世界需要你持续地提出好问题。", "title_alternative": "Questions and Answers", "avatar_mini": "https://cdn.v2ex.com/navatar/c20a/d4d7/12_mini.png?m=1650095340", "stars": 3886, "aliases": [], "root": false, "id": 12, "parent_node_name": "v2ex"}, "member": {"id": 443594, "username": "jimor", "url": "https://www.v2ex.com/u/jimor", "website": null, "twitter": null, "psn": null, "github": null, "btc": null, "location": null, "tagline": null, "bio": null, "avatar_mini": "https://cdn.v2ex.com/gravatar/c36dcd5fcd6d87480bd300f07cbd7255?s=24&d=retro", "avatar_normal": "https://cdn.v2ex.com/gravatar/c36dcd5fcd6d87480bd300f07cbd7255?s=48&d=retro", "avatar_large": "https://cdn.v2ex.com/gravatar/c36dcd5fcd6d87480bd300f07cbd7255?s=73&d=retro", "created": 1569555264, "last_modified": 1569555264}, "last_reply_by": "8355", "last_touched": 1690445031, "title": "公司快撑不住了，倒闭能有补偿吗", "url": "https://www.v2ex.com/t/960095", "created": 1690423212, "deleted": 0, "content": "背景：\r\n1 、小公司十几号人，其实也算是人情社会了，基本都是三年以上的员工，跟大家跟老板关系平时都还算不错；\r\n2 、算是疫情跟老板决策失误，今年押宝的几个项目都没其他（说起来也很神奇，现在回过头来看全是大坑\r\n3 、几个月前老板就跟我们几个核心员工吃饭时诉苦了，公司账上没钱，被迫接了些外包，回款慢，现在都是他自己在贴钱，工资差点都发不出了；\r\n4 、这周的周会，老板表示准备跟每个人谈话，下周有些同事要看不到了。\r\n结果：\r\n1 、跟我谈的时候，基本说明了给其他同事的安排，只保留两个前端一个后端维护剩余项目，其他开发老板打算推到他朋友的公司（也问了我的意见，但路程太远了我完全不考虑），测试 ui 产品运营全都不要了；\r\n2 、这一周下来陆陆续续谈完了，私下几个同事都跟我说，不乐意去老板朋友的公司，但又留不下，说不想撕破脸皮，只能辞职；\r\n3 、ui 被谈话了，应该也是劝退，大晚上憋不住，跑去问 hr 有没有赔偿；\r\n4 、其实老板的思路也很明确了，就是劝退，可以说八成没赔偿了，而且做完眼前项目后应该是要倒闭了；\r\n5 、现在剩下的几个员工也很憋屈了，明摆着只有劝退或者自己辞职，只能考虑熬完当前项目看公司倒闭后有没有遣散费了。\r\n讨论：\r\n1 、被劝退的 ui ，不愿意去另一家公司的同事，目前都表示不想仲裁不想闹僵，基本就等于裸辞了，不过如果是辞职应该还能干一段时间，方便找工作啥的；\r\n2 、这种情况我应该咋办，作为留守的一员，基本就看着卸磨杀驴了，做完手头的项目后，基本就等着倒闭，唯一期望是发个月的遣散费。", "content_rendered": "背景：<br />1 、小公司十几号人，其实也算是人情社会了，基本都是三年以上的员工，跟大家跟老板关系平时都还算不错；<br />2 、算是疫情跟老板决策失误，今年押宝的几个项目都没其他（说起来也很神奇，现在回过头来看全是大坑<br />3 、几个月前老板就跟我们几个核心员工吃饭时诉苦了，公司账上没钱，被迫接了些外包，回款慢，现在都是他自己在贴钱，工资差点都发不出了；<br />4 、这周的周会，老板表示准备跟每个人谈话，下周有些同事要看不到了。<br />结果：<br />1 、跟我谈的时候，基本说明了给其他同事的安排，只保留两个前端一个后端维护剩余项目，其他开发老板打算推到他朋友的公司（也问了我的意见，但路程太远了我完全不考虑），测试 ui 产品运营全都不要了；<br />2 、这一周下来陆陆续续谈完了，私下几个同事都跟我说，不乐意去老板朋友的公司，但又留不下，说不想撕破脸皮，只能辞职；<br />3 、ui 被谈话了，应该也是劝退，大晚上憋不住，跑去问 hr 有没有赔偿；<br />4 、其实老板的思路也很明确了，就是劝退，可以说八成没赔偿了，而且做完眼前项目后应该是要倒闭了；<br />5 、现在剩下的几个员工也很憋屈了，明摆着只有劝退或者自己辞职，只能考虑熬完当前项目看公司倒闭后有没有遣散费了。<br />讨论：<br />1 、被劝退的 ui ，不愿意去另一家公司的同事，目前都表示不想仲裁不想闹僵，基本就等于裸辞了，不过如果是辞职应该还能干一段时间，方便找工作啥的；<br />2 、这种情况我应该咋办，作为留守的一员，基本就看着卸磨杀驴了，做完手头的项目后，基本就等着倒闭，唯一期望是发个月的遣散费。", "last_modified": 1690423212, "replies": 77, "id": 960095}, {"node": {"avatar_large": "https://cdn.v2ex.com/navatar/38af/8613/176_large.png?m=1644885960", "name": "car", "avatar_normal": "https://cdn.v2ex.com/navatar/38af/8613/176_normal.png?m=1644885960", "title": "汽车", "url": "https://www.v2ex.com/go/car", "topics": 1653, "footer": "", "header": "关于买车、开车及汽车文化的技术讨论", "title_alternative": "Car", "avatar_mini": "https://cdn.v2ex.com/navatar/38af/8613/176_mini.png?m=1644885960", "stars": 1568, "aliases": [], "root": false, "id": 176, "parent_node_name": "life"}, "member": {"id": 597281, "username": "MRlaopeng", "url": "https://www.v2ex.com/u/MRlaopeng", "website": null, "twitter": null, "psn": null, "github": null, "btc": null, "location": null, "tagline": null, "bio": null, "avatar_mini": "https://cdn.v2ex.com/gravatar/e915aefc606d734635fad82f240a5455?s=24&d=retro", "avatar_normal": "https://cdn.v2ex.com/gravatar/e915aefc606d734635fad82f240a5455?s=48&d=retro", "avatar_large": "https://cdn.v2ex.com/gravatar/e915aefc606d734635fad82f240a5455?s=73&d=retro", "created": 1665632755, "last_modified": 1665632755}, "last_reply_by": "tigerstudent", "last_touched": 1690444823, "title": "准备买宋 prodmi 冠军版, 新车验车得咋验啊", "url": "https://www.v2ex.com/t/960087", "created": 1690422367, "deleted": 0, "content": "第一次买车不是很懂", "content_rendered": "<p>第一次买车不是很懂</p>\n", "last_modified": 1690422367, "replies": 66, "id": 960087}]